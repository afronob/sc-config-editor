<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Test D√©tection Dispositifs - Step 2</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .device-item { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .device-name { font-weight: bold; }
        .device-details { font-size: 12px; color: #666; margin-top: 5px; }
        .btn { padding: 8px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .detection-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .devices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .devices-section { background: #f8f9fa; border-radius: 8px; padding: 20px; }
        .status-known { background: #28a745; color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px; }
        .status-new { background: #ffc107; color: black; padding: 4px 8px; border-radius: 3px; font-size: 12px; }
        .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    </style>
</head>
<body>
    <h1>üéÆ Test de D√©tection des Dispositifs - √âtape 2</h1>
    <p>Test rapide pour v√©rifier que la d√©tection des dispositifs fonctionne avec votre Saitek.</p>
    
    <!-- Section de d√©tection -->
    <div class="detection-section">
        <h3>üîç D√©tection automatique des dispositifs</h3>
        <p>Connectez vos manettes et cliquez sur "D√©tecter" pour identifier automatiquement vos dispositifs.</p>
        
        <button class="btn btn-primary" onclick="detectDevices()">
            üîç D√©tecter les dispositifs connect√©s
        </button>
    </div>
    
    <!-- R√©sultats de d√©tection -->
    <div class="devices-grid">
        <!-- Dispositifs connus -->
        <div class="devices-section">
            <h4>‚úÖ Dispositifs reconnus (<span id="knownCount">0</span>)</h4>
            <div id="knownDevices">
                <p><em>Aucun dispositif reconnu pour l'instant</em></p>
            </div>
        </div>
        
        <!-- Nouveaux dispositifs -->
        <div class="devices-section">
            <h4>üÜï Nouveaux dispositifs (<span id="newCount">0</span>)</h4>
            <div id="newDevices">
                <p><em>Cliquez sur "D√©tecter" pour identifier les nouveaux dispositifs</em></p>
            </div>
        </div>
    </div>
    
    <!-- Zone de logs -->
    <div class="detection-section">
        <h4>üìã Logs de d√©tection</h4>
        <div id="logs" style="background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 3px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
        </div>
    </div>

    <script>
        let devicesDataJs = []; // Simule les donn√©es des dispositifs
        
        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        async function loadDevicesData() {
            try {
                const response = await fetch('get_devices_data.php');
                devicesDataJs = await response.json();
                log(`‚úÖ Donn√©es des dispositifs charg√©es: ${devicesDataJs.length} dispositifs dans la base`);
            } catch (error) {
                log(`‚ùå Erreur de chargement des donn√©es: ${error.message}`);
                devicesDataJs = []; // Continuer sans donn√©es
            }
        }
        
        function detectDevices() {
            log('üîç D√©but de la d√©tection des dispositifs');
            
            // R√©initialiser l'affichage
            clearDynamicDevices();
            
            // V√©rifier les gamepads connect√©s via l'API Gamepad
            const gamepads = navigator.getGamepads();
            let devicesFound = 0;
            let unknownDevicesFound = 0;
            
            log(`üìä ${gamepads.length} slots de gamepad v√©rifi√©s`);
            
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    devicesFound++;
                    log(`üéÆ Dispositif trouv√©: ${gamepads[i].id}`);
                    log(`   - Index: ${i}`);
                    log(`   - Boutons: ${gamepads[i].buttons.length}`);
                    log(`   - Axes: ${gamepads[i].axes.length}`);
                    
                    // V√©rifier si le dispositif est connu
                    const isKnown = checkIfDeviceIsKnown(gamepads[i]);
                    
                    if (isKnown) {
                        addDeviceToKnownSection(gamepads[i]);
                    } else {
                        unknownDevicesFound++;
                        addDeviceToNewSection(gamepads[i]);
                    }
                }
            }
            
            // Mettre √† jour les compteurs
            document.getElementById('knownCount').textContent = devicesFound - unknownDevicesFound;
            document.getElementById('newCount').textContent = unknownDevicesFound;
            
            // Afficher un message de r√©sultat
            showDetectionMessage(devicesFound, unknownDevicesFound);
            
            log(`‚úÖ D√©tection termin√©e: ${devicesFound} dispositifs trouv√©s, ${unknownDevicesFound} nouveaux`);
        }
        
        function checkIfDeviceIsKnown(gamepad) {
            if (!devicesDataJs || !Array.isArray(devicesDataJs) || devicesDataJs.length === 0) {
                log('‚ö†Ô∏è Donn√©es des dispositifs non disponibles, tous consid√©r√©s comme nouveaux');
                return false;
            }
            
            const gamepadIdSimple = gamepad.id.toLowerCase().replace(/\s+/g, ' ').trim();
            
            // Chercher dans la base de donn√©es des dispositifs
            const found = devicesDataJs.find(device => {
                if (!device.name) return false;
                
                const deviceNameSimple = device.name.toLowerCase().replace(/\s+/g, ' ').trim();
                return gamepadIdSimple.includes(deviceNameSimple) || deviceNameSimple.includes(gamepadIdSimple);
            });
            
            if (found) {
                log(`‚úÖ Dispositif reconnu: ${gamepad.id} -> ${found.name}`);
                return true;
            }
            
            log(`‚ùì Dispositif non reconnu: ${gamepad.id}`);
            return false;
        }
        
        function clearDynamicDevices() {
            document.getElementById('knownDevices').innerHTML = '<p><em>Aucun dispositif reconnu pour l\'instant</em></p>';
            document.getElementById('newDevices').innerHTML = '<p><em>Aucun nouveau dispositif d√©tect√©</em></p>';
            
            // Supprimer les anciens messages
            const messages = document.querySelectorAll('.detection-result-message');
            messages.forEach(msg => msg.remove());
        }
        
        function addDeviceToKnownSection(gamepad) {
            const container = document.getElementById('knownDevices');
            if (container.querySelector('em')) {
                container.innerHTML = ''; // Supprimer le message par d√©faut
            }
            
            const deviceHtml = `
                <div class="device-item">
                    <div class="device-name">${gamepad.id}</div>
                    <div class="device-details">
                        Connect√© physiquement<br>
                        Boutons: ${gamepad.buttons.length}, Axes: ${gamepad.axes.length}
                    </div>
                    <span class="status-known">Reconnu</span>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', deviceHtml);
        }
        
        function addDeviceToNewSection(gamepad) {
            const container = document.getElementById('newDevices');
            if (container.querySelector('em')) {
                container.innerHTML = ''; // Supprimer le message par d√©faut
            }
            
            // Extraire les IDs vendor/product
            const extractVendorProductId = (gamepadId) => {
                const vendor = gamepadId.match(/Vendor:\s*([0-9a-fA-F]{4})/);
                const product = gamepadId.match(/Product:\s*([0-9a-fA-F]{4})/);
                return {
                    vendor: vendor ? vendor[1] : null,
                    product: product ? product[1] : null
                };
            };
            
            const ids = extractVendorProductId(gamepad.id);
            
            const deviceHtml = `
                <div class="device-item">
                    <div class="device-name">${gamepad.id}</div>
                    <div class="device-details">
                        Vendor ID: ${ids.vendor ? `0x${ids.vendor}` : 'N/A'}<br>
                        Product ID: ${ids.product ? `0x${ids.product}` : 'N/A'}<br>
                        Boutons: ${gamepad.buttons.length}, Axes: ${gamepad.axes.length}
                    </div>
                    <span class="status-new">Nouveau</span>
                    <button class="btn btn-success" onclick="alert('Configuration √† impl√©menter')">
                        Configurer
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', deviceHtml);
        }
        
        function showDetectionMessage(totalDevices, unknownDevices) {
            let message = '';
            let messageClass = '';
            
            if (totalDevices === 0) {
                message = '‚ùå Aucun dispositif de jeu d√©tect√©. V√©rifiez que vos manettes sont bien connect√©es.';
                messageClass = 'alert-warning';
            } else if (unknownDevices === 0) {
                message = `‚úÖ ${totalDevices} dispositif(s) d√©tect√©(s), tous sont d√©j√† configur√©s !`;
                messageClass = 'alert-success';
            } else {
                message = `üîç ${totalDevices} dispositif(s) d√©tect√©(s), dont ${unknownDevices} nouveau(x) n√©cessitant une configuration.`;
                messageClass = 'alert-info';
            }
            
            const messageHtml = `
                <div class="alert ${messageClass} detection-result-message">
                    ${message}
                </div>
            `;
            
            const detectionSection = document.querySelector('.detection-section');
            detectionSection.insertAdjacentHTML('afterend', messageHtml);
        }
        
        // Initialisation au chargement
        window.addEventListener('load', function() {
            log('üöÄ Initialisation du test de d√©tection');
            loadDevicesData();
        });
    </script>
</body>
</html>
