<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fallback Endpoint - Saitek X-56</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .error { background-color: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .info { background-color: #d1ecf1; color: #0c5460; border-left: 5px solid #17a2b8; }
        .warning { background-color: #fff3cd; color: #856404; border-left: 5px solid #ffc107; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        #console-logs { height: 400px; overflow-y: auto; background: #1e1e1e; color: #fff; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; }
        .timestamp { color: #888; }
        .log-info { color: #4fc3f7; }
        .log-success { color: #4caf50; }
        .log-error { color: #f44336; }
        .log-warn { color: #ff9800; }
    </style>
</head>
<body>
    <h1>üîß Test Fallback Endpoint - Saitek X-56</h1>
    
    <div class="status info">
        <strong>Objectif :</strong> Tester le fallback vers l'endpoint /get_devices_data.php quand les donn√©es PHP sont vides
    </div>
    
    <div id="status-container">
        <div class="status warning">
            <strong>‚è≥ Test en cours...</strong> Simulation d'une page sans donn√©es PHP (comme keybind_editor.php)
        </div>
    </div>
    
    <h2>üìã Console Logs</h2>
    <div id="console-logs"></div>
    
    <h2>üìä R√©sultats</h2>
    <div id="results-container"></div>

    <script type="module">
        // Simulation de l'environnement keybind_editor.php
        const statusContainer = document.getElementById('status-container');
        const resultsContainer = document.getElementById('results-container');
        const consoleLogsDiv = document.getElementById('console-logs');
        
        // Capturer et afficher les logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const div = document.createElement('div');
            div.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="log-${type}">${type.toUpperCase()}: ${message}</span>`;
            consoleLogsDiv.appendChild(div);
            consoleLogsDiv.scrollTop = consoleLogsDiv.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog.apply(console, args);
            addToConsole('info', ...args);
        };
        
        console.warn = (...args) => {
            originalWarn.apply(console, args);
            addToConsole('warn', ...args);
        };
        
        console.error = (...args) => {
            originalError.apply(console, args);
            addToConsole('error', ...args);
        };

        async function testFallbackEndpoint() {
            try {
                console.log('üß™ D√©but du test - Simulation de keybind_editor.php');
                
                // Simuler l'environnement de keybind_editor.php : donn√©es PHP vides
                window.devicesDataJs = []; // Array vide comme dans upload_form
                console.log('üìã Simulation: window.devicesDataJs initialis√© √† []');
                
                // Importer SCConfigEditor
                const { SCConfigEditor } = await import('/assets/js/scConfigEditor.js');
                
                console.log('üöÄ Cr√©ation SCConfigEditor avec donn√©es vides...');
                
                // Cr√©er l'instance comme dans layout.php
                const config = {
                    buttonNamesByInstance: {},
                    devicesData: [] // Donn√©es vides comme sur keybind_editor.php
                };
                
                const editor = new SCConfigEditor(config);
                
                // Attendre l'initialisation compl√®te (6 secondes)
                console.log('‚è±Ô∏è Attente de l\'initialisation compl√®te (6 secondes)...');
                
                setTimeout(() => {
                    console.log('üß™ Test de d√©tection apr√®s initialisation...');
                    
                    // Tester avec le Saitek X-56
                    const mockSaitekGamepad = {
                        id: "Saitek Pro Flight X-56 Rhino Throttle (Vendor: 0738 Product: a221)",
                        index: 0,
                        connected: true
                    };
                    
                    console.log('üîç Test isDeviceKnown pour Saitek X-56...');
                    const isKnown = editor.deviceAutoDetection.isDeviceKnown(mockSaitekGamepad);
                    
                    console.log('üìã window.devicesDataJs disponible:', !!window.devicesDataJs);
                    console.log('üìã Nombre de devices:', window.devicesDataJs?.length || 0);
                    console.log('üìã R√©sultat isDeviceKnown:', isKnown);
                    
                    // V√©rifier si le Saitek est dans les donn√©es
                    const saitekInData = window.devicesDataJs?.find(dev => 
                        dev.vendor_id === '0x0738' && dev.product_id === '0xa221'
                    );
                    
                    console.log('üìã Saitek trouv√© dans les donn√©es:', !!saitekInData);
                    
                    // Afficher le r√©sultat
                    if (isKnown && saitekInData) {
                        resultsContainer.innerHTML = `
                            <div class="status success">
                                ‚úÖ <strong>SUCC√àS COMPLET</strong>
                                <br>‚Ä¢ Fallback vers l'endpoint fonctionne
                                <br>‚Ä¢ Saitek X-56 d√©tect√© comme device CONNU
                                <br>‚Ä¢ Donn√©es charg√©es: ${window.devicesDataJs.length} devices
                                <br>‚Ä¢ Plus de fausse d√©tection "nouveau device"
                            </div>
                        `;
                        
                        statusContainer.innerHTML = `
                            <div class="status success">
                                <strong>üéâ CORRECTION R√âUSSIE !</strong> Le fallback endpoint r√©sout le probl√®me sur keybind_editor.php
                            </div>
                        `;
                    } else if (window.devicesDataJs && window.devicesDataJs.length > 0 && !isKnown) {
                        resultsContainer.innerHTML = `
                            <div class="status error">
                                ‚ùå <strong>√âCHEC PARTIEL</strong>
                                <br>‚Ä¢ Fallback vers l'endpoint fonctionne (${window.devicesDataJs.length} devices)
                                <br>‚Ä¢ Mais Saitek X-56 encore d√©tect√© comme INCONNU
                                <br>‚Ä¢ Probl√®me dans isDeviceKnown() ou donn√©es
                            </div>
                        `;
                        
                        statusContainer.innerHTML = `
                            <div class="status warning">
                                <strong>‚ö†Ô∏è PROBL√àME D√âTECT√â</strong> Les donn√©es sont charg√©es mais la d√©tection √©choue
                            </div>
                        `;
                    } else {
                        resultsContainer.innerHTML = `
                            <div class="status error">
                                ‚ùå <strong>√âCHEC COMPLET</strong>
                                <br>‚Ä¢ Fallback vers l'endpoint √©chou√©
                                <br>‚Ä¢ window.devicesDataJs: ${window.devicesDataJs?.length || 0} devices
                                <br>‚Ä¢ Saitek encore d√©tect√© comme nouveau device
                            </div>
                        `;
                        
                        statusContainer.innerHTML = `
                            <div class="status error">
                                <strong>‚ùå CORRECTION √âCHOU√âE</strong> Le fallback endpoint ne fonctionne pas
                            </div>
                        `;
                    }
                }, 6000);
                
            } catch (error) {
                console.error('‚ùå Erreur durant le test:', error);
                
                resultsContainer.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>ERREUR DURANT LE TEST</strong>
                        <br>‚Ä¢ Message: ${error.message}
                        <br>‚Ä¢ Le test n'a pas pu se terminer
                    </div>
                `;
                
                statusContainer.innerHTML = `
                    <div class="status error">
                        <strong>‚ùå TEST √âCHOU√â</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Lancer le test
        testFallbackEndpoint();
    </script>
</body>
</html>
