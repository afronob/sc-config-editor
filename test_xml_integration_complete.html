<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Test Int√©gration XML Compl√®te</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }

        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        .test-button:hover {
            background: #005a8b;
        }

        .test-button.success {
            background: #28a745;
        }

        .test-button.error {
            background: #dc3545;
        }

        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }

        .status {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }

        .test-card {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007cba;
            background: white;
        }

        .test-card.passed {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .test-card.failed {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .xml-loader {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed #007cba;
            border-radius: 8px;
            text-align: center;
        }

        .xml-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test d'Int√©gration XML Compl√®te</h1>
        <p>Validation du syst√®me d'instanciation automatique de devices dans XML Star Citizen</p>

        <!-- Chargement XML -->
        <div class="test-section">
            <h3>üìÅ Chargement du XML Star Citizen</h3>
            <div class="xml-loader">
                <input type="file" id="xmlFileInput" accept=".xml" style="display: none;">
                <button class="test-button" onclick="document.getElementById('xmlFileInput').click()">
                    üìÇ Charger Fichier XML
                </button>
                <p>Ou utiliser le XML de test :</p>
                <button class="test-button" onclick="loadTestXML()">
                    üß™ Charger XML de Test
                </button>
            </div>
            <div id="xmlStatus" class="status info">Aucun XML charg√©</div>
            <div id="xmlContent" class="xml-content" style="display: none;"></div>
        </div>

        <!-- Simulation Device -->
        <div class="test-section">
            <h3>üéÆ Simulation de Device</h3>
            <button class="test-button" onclick="simulateNewDevice()">
                üéØ Simuler Device VKB NXT
            </button>
            <button class="test-button" onclick="simulateGenericDevice()">
                üéÆ Simuler Device G√©n√©rique
            </button>
            <button class="test-button" onclick="clearNotifications()">
                üßπ Nettoyer Notifications
            </button>
        </div>

        <!-- Tests Automatiques -->
        <div class="test-section">
            <h3>üß™ Tests Automatiques</h3>
            <button class="test-button" onclick="runFullWorkflowTest()">
                üöÄ Test Workflow Complet
            </button>
            <button class="test-button" onclick="testXMLInstancer()">
                üîß Test XMLDeviceInstancer
            </button>
            <button class="test-button" onclick="testDownloadFlow()">
                üì• Test T√©l√©chargement XML
            </button>
        </div>

        <!-- R√©sultats -->
        <div class="test-section">
            <h3>üìä R√©sultats des Tests</h3>
            <div id="testResults"></div>
        </div>

        <!-- Statut et Logs -->
        <div id="status" class="status info">
            Syst√®me en attente d'initialisation...
        </div>

        <div id="log" class="log">
Logs d'initialisation :
        </div>
    </div>

    <script type="module">
        import { DeviceAutoDetection } from './assets/js/modules/deviceAutoDetector.js';
        import { DeviceSetupUI } from './assets/js/modules/deviceSetupUI.js';
        import { XMLDeviceInstancer } from './assets/js/modules/xmlDeviceInstancer.js';

        let autoDetection, setupUI, xmlInstancer;
        let testResults = {};
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');

        function log(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] [${type}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[XMLIntegrationTest] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function createTestCard(title, result, details = '') {
            const card = document.createElement('div');
            card.className = `test-card ${result ? 'passed' : 'failed'}`;
            card.innerHTML = `
                <h4>${result ? '‚úÖ' : '‚ùå'} ${title}</h4>
                <p>${details}</p>
            `;
            return card;
        }

        // XML de test avec des devices existants
        const testXMLContent = `<?xml version="1.0" encoding="UTF-8"?>
<ActionMaps version="1" optionsVersion="2" rebindVersion="2" profileName="3242_BSC_NXT_PTU_exported">
    <options>
        <devices>
            <keyboard instance="1"/>
            <mouse instance="1"/>
            <joystick instance="1"/>
            <joystick instance="2"/>
        </devices>
    </options>
    
    <options type="keyboard" instance="1"/>
    <options type="mouse" instance="1"/>
    <options type="joystick" instance="1" Product="VKB-Sim Gladiator NXT EVO R {4C040100-0000-0000-0000-504944564944}"/>
    <options type="joystick" instance="2" Product="Generic USB Joystick {12340000-0000-0000-0000-504944564944}"/>
    
    <actionmap name="spaceship_movement">
        <action name="v_pitch">
            <rebind input="js1_x"/>
        </action>
        <action name="v_yaw">
            <rebind input="js1_y"/>
        </action>
    </actionmap>
</ActionMaps>`;

        async function initializeSystem() {
            try {
                log('üîß Initialisation du syst√®me de test XML...');
                
                // Donn√©es de test des devices connus
                window.devicesDataJs = [
                    {
                        "id": "VKB-Sim Gladiator NXT EVO R",
                        "vendor_id": "0x231d",
                        "product_id": "0x0201",
                        "xml_instance": "231d_0201"
                    }
                ];

                // Initialiser les modules
                autoDetection = new DeviceAutoDetection();
                setupUI = new DeviceSetupUI(null, autoDetection);
                xmlInstancer = new XMLDeviceInstancer();
                
                // Rendre disponibles globalement
                window.deviceAutoDetection = autoDetection;
                window.deviceSetupUI = setupUI;
                window.xmlInstancer = xmlInstancer;
                
                log('‚úÖ Syst√®me initialis√© avec succ√®s');
                updateStatus('‚úÖ Syst√®me pr√™t pour les tests', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur d'initialisation: ${error.message}`, 'ERROR');
                updateStatus('‚ùå Erreur d\'initialisation', 'error');
            }
        }

        // Fonctions globales pour les boutons
        window.loadTestXML = function() {
            try {
                // Simuler le chargement du XML dans l'√©diteur principal
                window.scConfigEditor = {
                    currentXMLContent: testXMLContent
                };
                
                document.getElementById('xmlContent').textContent = testXMLContent;
                document.getElementById('xmlContent').style.display = 'block';
                document.getElementById('xmlStatus').textContent = 'XML de test charg√© avec succ√®s';
                document.getElementById('xmlStatus').className = 'status success';
                
                log('‚úÖ XML de test charg√©');
                
            } catch (error) {
                log(`‚ùå Erreur lors du chargement XML: ${error.message}`, 'ERROR');
            }
        };

        window.simulateNewDevice = function() {
            log('üéÆ Simulation d\'un nouveau device VKB NXT...', 'TEST');
            
            const deviceKey = 'test_vkb_' + Date.now();
            const fakeDeviceInfo = {
                id: 'VKB-Sim Gladiator NXT EVO L',
                vendor_id: '0x231d',
                product_id: '0x0200',
                gamepad: {
                    id: 'VKB-Sim Gladiator NXT EVO L',
                    axes: Array(6).fill(0),
                    buttons: Array(32).fill({ pressed: false, value: 0 }),
                    index: 2
                },
                axes: 6,
                buttons: 32
            };

            // Ajouter √† la liste des devices inconnus
            autoDetection.unknownDevices.set(deviceKey, fakeDeviceInfo);
            
            // D√©clencher la notification
            setupUI.showNewDeviceNotification(fakeDeviceInfo);
            
            log('‚úÖ Device VKB simul√© et notification affich√©e');
            updateStatus('üì± Nouveau device VKB d√©tect√©', 'info');
        };

        window.simulateGenericDevice = function() {
            log('üéÆ Simulation d\'un device g√©n√©rique...', 'TEST');
            
            const deviceKey = 'test_generic_' + Date.now();
            const fakeDeviceInfo = {
                id: 'Test Generic Controller',
                vendor_id: '0x9999',
                product_id: '0x8888',
                gamepad: {
                    id: 'Test Generic Controller',
                    axes: Array(4).fill(0),
                    buttons: Array(16).fill({ pressed: false, value: 0 }),
                    index: 3
                },
                axes: 4,
                buttons: 16
            };

            autoDetection.unknownDevices.set(deviceKey, fakeDeviceInfo);
            setupUI.showNewDeviceNotification(fakeDeviceInfo);
            
            log('‚úÖ Device g√©n√©rique simul√© et notification affich√©e');
            updateStatus('üì± Nouveau device g√©n√©rique d√©tect√©', 'info');
        };

        window.clearNotifications = function() {
            document.querySelectorAll('.device-notification').forEach(notification => {
                notification.remove();
            });
            log('üßπ Notifications nettoy√©es');
        };

        window.testXMLInstancer = function() {
            log('üîß Test du module XMLDeviceInstancer...', 'TEST');
            
            const resultsContainer = document.getElementById('testResults');
            
            try {
                // Test d'initialisation
                const initialized = xmlInstancer.initialize(testXMLContent);
                resultsContainer.appendChild(createTestCard(
                    'Initialisation XMLInstancer',
                    initialized,
                    initialized ? 'XML pars√© avec succ√®s' : '√âchec du parsing'
                ));

                if (initialized) {
                    // Test de d√©tection d'instance
                    const nextInstance = xmlInstancer.getNextAvailableInstance();
                    const expectedInstance = 3; // Apr√®s instances 1 et 2
                    resultsContainer.appendChild(createTestCard(
                        'D√©tection Instance Suivante',
                        nextInstance === expectedInstance,
                        `Instance trouv√©e: ${nextInstance}, attendue: ${expectedInstance}`
                    ));

                    // Test de g√©n√©ration d'info device
                    const testDevice = {
                        id: 'Test Device',
                        vendor_id: '0x1234',
                        product_id: '0x5678'
                    };
                    const deviceInfo = xmlInstancer.generateDeviceXMLInfo(testDevice, nextInstance);
                    resultsContainer.appendChild(createTestCard(
                        'G√©n√©ration Info Device',
                        deviceInfo && deviceInfo.xmlId && deviceInfo.productName,
                        `ID: ${deviceInfo?.xmlId}, Product: ${deviceInfo?.productName}`
                    ));

                    // Test de g√©n√©ration XML
                    const modifiedXML = xmlInstancer.generateModifiedXML(deviceInfo);
                    const hasNewDeclaration = modifiedXML.includes(`<joystick instance="${nextInstance}"/>`);
                    resultsContainer.appendChild(createTestCard(
                        'G√©n√©ration XML Modifi√©',
                        hasNewDeclaration,
                        hasNewDeclaration ? 'Nouvelle d√©claration ajout√©e' : 'D√©claration manquante'
                    ));
                }
                
                log('‚úÖ Test XMLInstancer termin√©');
                
            } catch (error) {
                log(`‚ùå Erreur test XMLInstancer: ${error.message}`, 'ERROR');
                resultsContainer.appendChild(createTestCard(
                    'Test XMLInstancer',
                    false,
                    `Erreur: ${error.message}`
                ));
            }
        };

        window.runFullWorkflowTest = function() {
            log('üöÄ D√©marrage du test de workflow complet...', 'TEST');
            
            // Simuler un device et tenter le workflow complet
            if (!window.scConfigEditor || !window.scConfigEditor.currentXMLContent) {
                log('‚ö†Ô∏è Charger d\'abord un XML de test', 'WARNING');
                updateStatus('‚ö†Ô∏è XML de test requis', 'warning');
                return;
            }
            
            simulateNewDevice();
            
            setTimeout(() => {
                const notification = document.querySelector('.device-notification');
                if (notification) {
                    const configButton = notification.querySelector('.btn-primary');
                    if (configButton) {
                        log('üéØ D√©clenchement automatique de la configuration...');
                        configButton.click();
                        
                        setTimeout(() => {
                            const modal = document.getElementById('deviceSetupModal');
                            const isOpen = modal && modal.style.display !== 'none';
                            
                            const resultsContainer = document.getElementById('testResults');
                            resultsContainer.appendChild(createTestCard(
                                'Workflow Automatique',
                                isOpen,
                                isOpen ? 'Modal ouvert automatiquement' : '√âchec ouverture modal'
                            ));
                            
                            if (isOpen) {
                                log('‚úÖ Workflow automatique fonctionnel - modal ouvert');
                                updateStatus('‚úÖ Test workflow r√©ussi', 'success');
                            }
                        }, 500);
                    }
                }
            }, 100);
        };

        window.testDownloadFlow = function() {
            log('üì• Test du flux de t√©l√©chargement XML...', 'TEST');
            
            if (!xmlInstancer || !window.scConfigEditor?.currentXMLContent) {
                log('‚ö†Ô∏è XML de test requis', 'WARNING');
                return;
            }
            
            try {
                xmlInstancer.initialize(testXMLContent);
                const nextInstance = xmlInstancer.getNextAvailableInstance();
                
                const testDevice = {
                    id: 'Test Download Device',
                    vendor_id: '0xAAAA',
                    product_id: '0xBBBB'
                };
                
                const deviceInfo = xmlInstancer.generateDeviceXMLInfo(testDevice, nextInstance);
                const modifiedXML = xmlInstancer.generateModifiedXML(deviceInfo);
                const isValid = xmlInstancer.validateModifiedXML(modifiedXML);
                
                const resultsContainer = document.getElementById('testResults');
                resultsContainer.appendChild(createTestCard(
                    'G√©n√©ration XML pour T√©l√©chargement',
                    isValid && modifiedXML.length > testXMLContent.length,
                    isValid ? 'XML valide g√©n√©r√©' : 'XML invalide'
                ));
                
                if (isValid) {
                    log('‚úÖ Test t√©l√©chargement r√©ussi - XML valide g√©n√©r√©');
                    log(`üìä Taille originale: ${testXMLContent.length}, modifi√©e: ${modifiedXML.length}`);
                }
                
            } catch (error) {
                log(`‚ùå Erreur test t√©l√©chargement: ${error.message}`, 'ERROR');
            }
        };

        // Gestion du chargement de fichier XML
        document.getElementById('xmlFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    
                    // Simuler le chargement dans l'√©diteur principal
                    window.scConfigEditor = {
                        currentXMLContent: content
                    };
                    
                    document.getElementById('xmlContent').textContent = content.substring(0, 500) + '...';
                    document.getElementById('xmlContent').style.display = 'block';
                    document.getElementById('xmlStatus').textContent = `Fichier XML charg√©: ${file.name}`;
                    document.getElementById('xmlStatus').className = 'status success';
                    
                    log(`‚úÖ Fichier XML charg√©: ${file.name} (${content.length} caract√®res)`);
                };
                reader.readAsText(file);
            }
        });

        // Initialiser au chargement de la page
        initializeSystem();
    </script>
</body>
</html>
