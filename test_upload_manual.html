<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>üéØ Test Manuel Upload XML</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .result { background: #d4edda; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #f5c6cb; }
        .iframe-container { border: 2px solid #dee2e6; border-radius: 8px; overflow: hidden; margin: 20px 0; }
        iframe { width: 100%; height: 600px; border: none; }
        .steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .step-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center; }
        .step-card.active { border-color: #007bff; background: #e7f3ff; }
        .step-card.completed { border-color: #28a745; background: #d4edda; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.danger { background: #dc3545; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéØ Test Manuel - Upload XML avec Statistiques</h1>
        
        <div class="test-section">
            <h2>üìã Plan de Test</h2>
            <p>Ce test v√©rifie que les statistiques d'actions XML s'affichent correctement apr√®s l'upload d'un fichier.</p>
            
            <div class="steps">
                <div class="step-card" id="step1">
                    <h3>1Ô∏è‚É£ √âtape Initiale</h3>
                    <p>Charger l'√©tape 1 vierge</p>
                    <button onclick="loadInitialStep()">Charger</button>
                </div>
                <div class="step-card" id="step2">
                    <h3>2Ô∏è‚É£ Upload Fichier</h3>
                    <p>Uploader un fichier XML de test</p>
                    <button onclick="uploadTestFile()">Upload</button>
                </div>
                <div class="step-card" id="step3">
                    <h3>3Ô∏è‚É£ V√©rifier Stats</h3>
                    <p>V√©rifier l'affichage des statistiques</p>
                    <button onclick="checkStatistics()">V√©rifier</button>
                </div>
                <div class="step-card" id="step4">
                    <h3>4Ô∏è‚É£ Navigation</h3>
                    <p>Tester la navigation vers l'√©tape 2</p>
                    <button onclick="testNavigation()">Tester</button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>üéÆ Contr√¥les de Test</h2>
            <button onclick="runFullTest()" class="success">üöÄ Test Complet</button>
            <button onclick="resetTest()" class="danger">üîÑ Reset</button>
            <button onclick="clearLog()">üßπ Clear Log</button>
            
            <h3>üìù Journal de Test</h3>
            <div id="log" class="log"></div>
        </div>

        <div class="test-section">
            <h2>üñ•Ô∏è Interface Live</h2>
            <div class="iframe-container">
                <iframe id="test-iframe" src="step_by_step_handler.php?step=1"></iframe>
            </div>
        </div>
    </div>

    <script>
        let currentStepIndex = 0;
        const steps = ['step1', 'step2', 'step3', 'step4'];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `step-card ${status}`;
        }

        function loadInitialStep() {
            log('Chargement de l\'√©tape 1 initiale...');
            setStepStatus('step1', 'active');
            
            const iframe = document.getElementById('test-iframe');
            iframe.src = 'step_by_step_handler.php?step=1&_t=' + Date.now();
            
            iframe.onload = () => {
                log('√âtape 1 charg√©e avec succ√®s', 'success');
                setStepStatus('step1', 'completed');
                
                // V√©rifier que la section upload est visible
                setTimeout(() => {
                    try {
                        const doc = iframe.contentDocument;
                        const uploadSection = doc.querySelector('.upload-section');
                        const statsSection = doc.querySelector('.file-uploaded-info');
                        
                        if (uploadSection) {
                            log('‚úì Section upload d√©tect√©e');
                        } else {
                            log('‚úó Section upload manquante', 'error');
                        }
                        
                        if (!statsSection) {
                            log('‚úì Section statistiques cach√©e (normal pour premi√®re visite)');
                        } else {
                            log('‚ö† Section statistiques visible (inattendu)', 'warning');
                        }
                    } catch (e) {
                        log('Impossible d\'acc√©der au contenu iframe: ' + e.message, 'error');
                    }
                }, 500);
            };
        }

        function uploadTestFile() {
            log('D√©marrage upload fichier test...');
            setStepStatus('step2', 'active');
            
            // Cr√©er un fichier XML de test
            const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<ActionMaps version="1" optionsVersion="2" rebindVersion="2" profileName="test">
  <actionmap name="spaceship_general">
    <action name="v_power_throttle">
      <rebind input="js1_button1"/>
    </action>
    <action name="v_power_shields">
      <rebind input="js1_button2" ActivationMode="hold"/>
    </action>
    <action name="v_power_weapons">
      <rebind input="js1_button3"/>
    </action>
    <action name="v_weapon_arm_missile">
    </action>
    <action name="v_weapon_launch_missile">
    </action>
  </actionmap>
  <actionmap name="spaceship_movement">
    <action name="v_pitch">
      <rebind input="js1_x"/>
    </action>
    <action name="v_yaw">
    </action>
    <action name="v_roll">
    </action>
  </actionmap>
</ActionMaps>`;

            // Cr√©er un FormData pour simuler l'upload
            const formData = new FormData();
            const file = new Blob([xmlContent], { type: 'application/xml' });
            formData.append('xmlfile', file, 'test_config.xml');

            // Envoyer la requ√™te POST
            fetch('step_by_step_handler.php?step=1&action=upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    log('Upload r√©ussi - Redirection d√©tect√©e', 'success');
                    setStepStatus('step2', 'completed');
                    
                    // Charger la nouvelle page
                    setTimeout(() => {
                        document.getElementById('test-iframe').src = response.url;
                        checkStatistics();
                    }, 1000);
                } else {
                    return response.text().then(html => {
                        if (html.includes('error') || html.includes('erreur')) {
                            log('Erreur durant upload', 'error');
                            setStepStatus('step2', 'error');
                        } else {
                            log('Upload trait√© (pas de redirection)', 'warning');
                            setStepStatus('step2', 'completed');
                            // Rafra√Æchir pour voir les changements
                            document.getElementById('test-iframe').src = 'step_by_step_handler.php?step=1&_t=' + Date.now();
                        }
                    });
                }
            })
            .catch(error => {
                log('Erreur lors de l\'upload: ' + error.message, 'error');
                setStepStatus('step2', 'error');
            });
        }

        function checkStatistics() {
            log('V√©rification affichage des statistiques...');
            setStepStatus('step3', 'active');
            
            setTimeout(() => {
                try {
                    const iframe = document.getElementById('test-iframe');
                    const doc = iframe.contentDocument;
                    
                    const statsSection = doc.querySelector('.file-uploaded-info');
                    const uploadSection = doc.querySelector('.upload-section');
                    
                    if (statsSection) {
                        log('‚úì Section statistiques trouv√©e!', 'success');
                        
                        // V√©rifier le contenu des statistiques
                        const fileName = statsSection.querySelector('.file-detail-item');
                        const stats = statsSection.querySelectorAll('.stat-highlight');
                        
                        if (fileName) {
                            log('‚úì Nom du fichier affich√©');
                        }
                        
                        if (stats && stats.length >= 2) {
                            log(`‚úì Statistiques trouv√©es: ${stats.length} √©l√©ments`);
                            stats.forEach((stat, index) => {
                                log(`  - Stat ${index + 1}: ${stat.textContent}`);
                            });
                        }
                        
                        const continueBtn = statsSection.querySelector('.btn-continue');
                        if (continueBtn) {
                            log('‚úì Bouton de navigation vers √©tape 2 trouv√©');
                        }
                        
                        setStepStatus('step3', 'completed');
                    } else {
                        log('‚úó Section statistiques non trouv√©e', 'error');
                        setStepStatus('step3', 'error');
                        
                        // Debug: lister toutes les sections
                        const allSections = doc.querySelectorAll('div[class*="section"], div[class*="info"]');
                        log(`Debug: ${allSections.length} sections trouv√©es dans la page`);
                        allSections.forEach((section, index) => {
                            log(`  - Section ${index}: ${section.className}`);
                        });
                    }
                    
                    if (!uploadSection || uploadSection.style.display === 'none') {
                        log('‚úì Section upload cach√©e (correct apr√®s upload)');
                    } else {
                        log('‚ö† Section upload encore visible', 'warning');
                    }
                    
                } catch (e) {
                    log('Erreur lors de la v√©rification: ' + e.message, 'error');
                    setStepStatus('step3', 'error');
                }
            }, 1000);
        }

        function testNavigation() {
            log('Test de navigation vers √©tape 2...');
            setStepStatus('step4', 'active');
            
            setTimeout(() => {
                try {
                    const iframe = document.getElementById('test-iframe');
                    const doc = iframe.contentDocument;
                    const continueBtn = doc.querySelector('.btn-continue');
                    
                    if (continueBtn) {
                        log('Clic sur le bouton de navigation...');
                        continueBtn.click();
                        
                        setTimeout(() => {
                            if (iframe.src.includes('step=2')) {
                                log('‚úì Navigation vers √©tape 2 r√©ussie!', 'success');
                                setStepStatus('step4', 'completed');
                            } else {
                                log('‚úó Navigation √©chou√©e', 'error');
                                setStepStatus('step4', 'error');
                            }
                        }, 1000);
                    } else {
                        log('‚úó Bouton de navigation non trouv√©', 'error');
                        setStepStatus('step4', 'error');
                    }
                } catch (e) {
                    log('Erreur navigation: ' + e.message, 'error');
                    setStepStatus('step4', 'error');
                }
            }, 500);
        }

        async function runFullTest() {
            log('üöÄ D√âMARRAGE TEST COMPLET', 'success');
            
            loadInitialStep();
            await sleep(3000);
            
            uploadTestFile();
            await sleep(4000);
            
            checkStatistics();
            await sleep(3000);
            
            testNavigation();
            await sleep(2000);
            
            log('üèÅ TEST COMPLET TERMIN√â', 'success');
        }

        function resetTest() {
            log('üîÑ Reset du test...');
            
            // Reset de l'iframe
            document.getElementById('test-iframe').src = 'step_by_step_handler.php?action=restart';
            
            // Reset des statuts des √©tapes
            steps.forEach(step => {
                setStepStatus(step, '');
            });
            
            currentStepIndex = 0;
            
            setTimeout(() => {
                document.getElementById('test-iframe').src = 'step_by_step_handler.php?step=1&_t=' + Date.now();
                log('Reset termin√©', 'success');
            }, 1000);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Auto-d√©marrage du premier test
        setTimeout(() => {
            log('üéØ Page de test charg√©e - Pr√™t pour les tests');
        }, 500);
    </script>
</body>
</html>
