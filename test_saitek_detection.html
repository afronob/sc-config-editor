<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test D√©tection Saitek</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .device-info {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        .error { border-left-color: #dc3545; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üéÆ Test de D√©tection Saitek</h1>
    <p>Test sp√©cifique pour v√©rifier que le "Saitek Pro Flight X-56 Rhino Throttle" est maintenant d√©tect√© comme device connu.</p>

    <div class="test-section">
        <h3>√âtat du Syst√®me</h3>
        <div id="systemStatus">Chargement...</div>
    </div>

    <div class="test-section">
        <h3>Test de Donn√©es</h3>
        <button onclick="testDevicesData()">Tester Chargement des Donn√©es</button>
        <button onclick="testSaitekDetection()">Test D√©tection Saitek</button>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h3>Simulation Saitek</h3>
        <button onclick="simulateSaitek()">Simuler Connexion Saitek</button>
        <div id="simulationResults"></div>
    </div>

    <div class="test-section">
        <h3>Log</h3>
        <div id="logOutput" class="log">Initialisation...\n</div>
        <button onclick="clearLog()">Effacer Log</button>
    </div>

    <script type="module">
        let deviceAutoDetection;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logOutput');
            
            const prefix = {
                'info': 'üîç',
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå'
            }[type] || 'üîç';
            
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Fonctions globales
        window.testDevicesData = async function() {
            log('Test de chargement des donn√©es devices...', 'info');
            try {
                const response = await fetch('/get_devices_data.php');
                const devicesData = await response.json();
                
                log(`‚úÖ ${devicesData.length} devices charg√©s`, 'success');
                
                // Chercher sp√©cifiquement le Saitek
                const saitekDevice = devicesData.find(dev => 
                    dev.id.includes('Saitek') && dev.id.includes('X-56')
                );
                
                if (saitekDevice) {
                    log(`‚úÖ Saitek trouv√©: ${saitekDevice.id}`, 'success');
                    log(`   Vendor: ${saitekDevice.vendor_id}, Product: ${saitekDevice.product_id}`, 'info');
                } else {
                    log('‚ùå Saitek NON trouv√© dans les donn√©es', 'error');
                }
                
                // Mettre √† jour window.devicesDataJs
                window.devicesDataJs = devicesData;
                log('‚úÖ window.devicesDataJs mis √† jour', 'success');
                
                document.getElementById('testResults').innerHTML = `
                    <div class="device-info success">
                        <strong>Donn√©es charg√©es:</strong> ${devicesData.length} devices<br>
                        <strong>Saitek trouv√©:</strong> ${saitekDevice ? '‚úÖ OUI' : '‚ùå NON'}
                    </div>
                `;
                
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                document.getElementById('testResults').innerHTML = `
                    <div class="device-info error">
                        <strong>Erreur:</strong> ${error.message}
                    </div>
                `;
            }
        };

        window.testSaitekDetection = function() {
            log('Test de la fonction isDeviceKnown pour Saitek...', 'info');
            
            if (!deviceAutoDetection) {
                log('‚ùå DeviceAutoDetection non initialis√©', 'error');
                return;
            }
            
            // Simuler un gamepad Saitek
            const mockSaitekGamepad = {
                id: 'Saitek Pro Flight X-56 Rhino Throttle (Vendor: 0738 Product: a221)',
                buttons: Array(20).fill({ pressed: false, value: 0 }),
                axes: Array(8).fill(0),
                index: 0,
                connected: true
            };
            
            const isKnown = deviceAutoDetection.isDeviceKnown(mockSaitekGamepad);
            
            log(`Test isDeviceKnown: ${isKnown ? '‚úÖ CONNU' : '‚ùå INCONNU'}`, isKnown ? 'success' : 'error');
            
            // Test d√©taill√©
            const ids = deviceAutoDetection.extractVendorProductIdFromGamepad(mockSaitekGamepad);
            log(`IDs extraits: vendor=${ids.vendor}, product=${ids.product}`, 'info');
            
            document.getElementById('testResults').innerHTML += `
                <div class="device-info ${isKnown ? 'success' : 'error'}">
                    <strong>Test isDeviceKnown:</strong> ${isKnown ? '‚úÖ CONNU' : '‚ùå INCONNU'}<br>
                    <strong>Vendor ID:</strong> ${ids.vendor}<br>
                    <strong>Product ID:</strong> ${ids.product}
                </div>
            `;
        };

        window.simulateSaitek = function() {
            log('Simulation connexion Saitek...', 'info');
            
            if (!deviceAutoDetection) {
                log('‚ùå DeviceAutoDetection non initialis√©', 'error');
                return;
            }
            
            const mockSaitekGamepad = {
                id: 'Saitek Pro Flight X-56 Rhino Throttle (Vendor: 0738 Product: a221)',
                buttons: Array(20).fill({ pressed: false, value: 0 }),
                axes: Array(8).fill(0),
                index: 0,
                connected: true
            };
            
            log('üéÆ Simulation handleGamepadConnected...', 'info');
            deviceAutoDetection.handleGamepadConnected(mockSaitekGamepad);
            
            // V√©rifier si le device a √©t√© ajout√© aux unknownDevices
            const unknownDevices = deviceAutoDetection.getUnknownDevices();
            const foundUnknown = unknownDevices.find(dev => dev.id.includes('Saitek'));
            
            if (foundUnknown) {
                log('‚ùå Saitek d√©tect√© comme INCONNU', 'error');
                document.getElementById('simulationResults').innerHTML = `
                    <div class="device-info error">
                        <strong>‚ùå PROBL√àME:</strong> Saitek encore d√©tect√© comme inconnu
                    </div>
                `;
            } else {
                log('‚úÖ Saitek correctement d√©tect√© comme CONNU', 'success');
                document.getElementById('simulationResults').innerHTML = `
                    <div class="device-info success">
                        <strong>‚úÖ SUCC√àS:</strong> Saitek d√©tect√© comme device connu
                    </div>
                `;
            }
        };

        window.clearLog = function() {
            document.getElementById('logOutput').textContent = '';
        };

        // Initialisation
        async function init() {
            try {
                log('üîß Chargement des donn√©es devices...', 'info');
                await window.testDevicesData();
                
                log('üîß Initialisation DeviceAutoDetection...', 'info');
                const { DeviceAutoDetection } = await import('./assets/js/modules/deviceAutoDetection.js');
                deviceAutoDetection = new DeviceAutoDetection();
                window.deviceAutoDetection = deviceAutoDetection;
                log('‚úÖ DeviceAutoDetection initialis√©', 'success');
                
                document.getElementById('systemStatus').innerHTML = `
                    <div class="device-info success">
                        <strong>‚úÖ Syst√®me initialis√©</strong><br>
                        Devices charg√©s: ${window.devicesDataJs ? window.devicesDataJs.length : 0}<br>
                        DeviceAutoDetection: ‚úÖ Pr√™t
                    </div>
                `;
                
                log('üéâ Initialisation termin√©e! Pr√™t pour les tests.', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur d'initialisation: ${error.message}`, 'error');
                document.getElementById('systemStatus').innerHTML = `
                    <div class="device-info error">
                        <strong>‚ùå Erreur d'initialisation:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Lancer l'initialisation
        init();
    </script>
</body>
</html>
