<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Syst√®me Complet - SC Config Editor</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .test-section {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 2rem;
            margin: 1.5rem 0;
            border: 1px solid #ddd;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1rem 0;
        }
        
        .test-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .status-success { background: #4CAF50; }
        .status-warning { background: #FF9800; }
        .status-error { background: #f44336; }
        .status-info { background: #2196F3; }
        
        .test-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: background 0.3s ease;
        }
        
        .test-button:hover {
            background: #0b7dda;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .back-button {
            display: inline-block;
            background: #2196F3;
            color: white;
            padding: 0.8rem 1.5rem;
            text-decoration: none;
            border-radius: 5px;
            margin: 1rem 0;
            transition: background 0.3s ease;
        }
        
        .back-button:hover {
            background: #0b7dda;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .log-container {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            margin: 1rem 0;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <header>
            <a href="index.html" class="back-button">‚Üê Retour √† l'accueil</a>
            <h1>üîß Test Syst√®me Complet</h1>
            <p>Suite de tests compl√®te pour v√©rifier toutes les fonctionnalit√©s du SC Config Editor</p>
        </header>

        <div class="test-section">
            <h2>√âtat global du syst√®me</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="global-progress"></div>
            </div>
            <p id="global-status">Pr√™t pour les tests...</p>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h3><span class="status-indicator status-info"></span>D√©tection des contr√¥leurs</h3>
                <p id="gamepad-detection-status">Non test√©</p>
                <button class="test-button" onclick="testGamepadDetection()">Tester la d√©tection</button>
                <button class="test-button" onclick="runGamepadTest()">Test approfondi</button>
            </div>

            <div class="test-card">
                <h3><span class="status-indicator status-info"></span>Configuration automatique</h3>
                <p id="auto-config-status">Non test√©</p>
                <button class="test-button" onclick="testAutoConfiguration()">Test auto-config</button>
                <button class="test-button" onclick="testConfigButton()">Test bouton config</button>
            </div>

            <div class="test-card">
                <h3><span class="status-indicator status-info"></span>Modes HAT/POV</h3>
                <p id="hat-modes-status">Non test√©</p>
                <button class="test-button" onclick="testHatModes()">Test HAT modes</button>
                <button class="test-button" onclick="testDynamicKeys()">Test cl√©s dynamiques</button>
            </div>

            <div class="test-card">
                <h3><span class="status-indicator status-info"></span>Sauvegarde des mappings</h3>
                <p id="save-mapping-status">Non test√©</p>
                <button class="test-button" onclick="testSaveMapping()">Test sauvegarde</button>
                <button class="test-button" onclick="testLoadMapping()">Test chargement</button>
            </div>

            <div class="test-card">
                <h3><span class="status-indicator status-info"></span>Interface utilisateur</h3>
                <p id="ui-status">Non test√©</p>
                <button class="test-button" onclick="testUI()">Test interface</button>
                <button class="test-button" onclick="testResponsive()">Test responsive</button>
            </div>

            <div class="test-card">
                <h3><span class="status-indicator status-info"></span>Validation syst√®me</h3>
                <p id="validation-status">Non test√©</p>
                <button class="test-button" onclick="runFullValidation()">Validation compl√®te</button>
                <button class="test-button" onclick="generateReport()">G√©n√©rer rapport</button>
            </div>
        </div>

        <div class="test-section">
            <h2>Tests automatis√©s</h2>
            <button class="test-button" onclick="runAllTests()" style="background: #4CAF50;">‚ñ∂Ô∏è Lancer tous les tests</button>
            <button class="test-button" onclick="clearAllTests()" style="background: #f44336;">üóëÔ∏è R√©initialiser</button>
            <button class="test-button" onclick="exportResults()" style="background: #FF9800;">üìÑ Exporter r√©sultats</button>
        </div>

        <div class="test-section">
            <h2>Journal des tests</h2>
            <div class="log-container" id="test-log">
                <!-- Les r√©sultats des tests appara√Ætront ici -->
            </div>
        </div>

        <div id="results-summary" style="display: none;" class="test-section">
            <h2>R√©sum√© des r√©sultats</h2>
            <div id="summary-content">
                <!-- Le r√©sum√© sera g√©n√©r√© ici -->
            </div>
        </div>
    </div>

    <script>
        let testResults = {};
        let totalTests = 0;
        let completedTests = 0;

        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            
            const typeIcon = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${typeIcon[type]} ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateProgress() {
            const percentage = totalTests > 0 ? (completedTests / totalTests) * 100 : 0;
            document.getElementById('global-progress').style.width = percentage + '%';
            document.getElementById('global-status').textContent = 
                `${completedTests}/${totalTests} tests termin√©s (${Math.round(percentage)}%)`;
        }

        function updateTestStatus(testName, status, message) {
            const statusElement = document.getElementById(testName + '-status');
            if (statusElement) {
                statusElement.textContent = message;
                
                // Mise √† jour de l'indicateur visuel
                const card = statusElement.closest('.test-card');
                const indicator = card.querySelector('.status-indicator');
                
                indicator.className = 'status-indicator ';
                switch (status) {
                    case 'success':
                        indicator.classList.add('status-success');
                        break;
                    case 'error':
                        indicator.classList.add('status-error');
                        break;
                    case 'warning':
                        indicator.classList.add('status-warning');
                        break;
                    default:
                        indicator.classList.add('status-info');
                }
            }
            
            testResults[testName] = { status, message, timestamp: new Date() };
            completedTests++;
            updateProgress();
        }

        async function testGamepadDetection() {
            log('D√©marrage du test de d√©tection des contr√¥leurs...', 'info');
            totalTests++;
            
            try {
                const gamepads = navigator.getGamepads();
                let detectedCount = 0;
                let detectedDevices = [];
                
                for (let i = 0; i < gamepads.length; i++) {
                    if (gamepads[i]) {
                        detectedCount++;
                        detectedDevices.push(gamepads[i].id);
                    }
                }
                
                if (detectedCount > 0) {
                    updateTestStatus('gamepad-detection', 'success', 
                        `${detectedCount} contr√¥leur(s) d√©tect√©(s)`);
                    log(`Contr√¥leurs d√©tect√©s: ${detectedDevices.join(', ')}`, 'success');
                } else {
                    updateTestStatus('gamepad-detection', 'warning', 
                        'Aucun contr√¥leur d√©tect√©');
                    log('Aucun contr√¥leur connect√© pour le test', 'warning');
                }
            } catch (error) {
                updateTestStatus('gamepad-detection', 'error', 
                    'Erreur lors de la d√©tection');
                log(`Erreur de d√©tection: ${error.message}`, 'error');
            }
        }

        async function testAutoConfiguration() {
            log('Test de la configuration automatique...', 'info');
            totalTests++;
            
            try {
                // Simuler le test de configuration automatique
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const gamepads = navigator.getGamepads();
                let configSuccess = false;
                
                for (let i = 0; i < gamepads.length; i++) {
                    if (gamepads[i]) {
                        configSuccess = true;
                        break;
                    }
                }
                
                if (configSuccess) {
                    updateTestStatus('auto-config', 'success', 
                        'Configuration automatique r√©ussie');
                    log('Configuration automatique des devices: OK', 'success');
                } else {
                    updateTestStatus('auto-config', 'warning', 
                        'Pas de device pour la config auto');
                    log('Aucun device disponible pour la configuration automatique', 'warning');
                }
            } catch (error) {
                updateTestStatus('auto-config', 'error', 
                    'Erreur configuration automatique');
                log(`Erreur configuration automatique: ${error.message}`, 'error');
            }
        }

        async function testHatModes() {
            log('Test des modes HAT/POV...', 'info');
            totalTests++;
            
            try {
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const gamepads = navigator.getGamepads();
                let hatSupported = false;
                
                for (let i = 0; i < gamepads.length; i++) {
                    if (gamepads[i] && gamepads[i].buttons.length > 12) {
                        hatSupported = true;
                        break;
                    }
                }
                
                if (hatSupported) {
                    updateTestStatus('hat-modes', 'success', 
                        'HAT/POV support√© et fonctionnel');
                    log('HAT/POV: Support d√©tect√© et fonctionnel', 'success');
                } else {
                    updateTestStatus('hat-modes', 'warning', 
                        'HAT/POV non d√©tect√©');
                    log('Aucun support HAT/POV d√©tect√© sur les devices connect√©s', 'warning');
                }
            } catch (error) {
                updateTestStatus('hat-modes', 'error', 
                    'Erreur test HAT modes');
                log(`Erreur test HAT modes: ${error.message}`, 'error');
            }
        }

        async function testSaveMapping() {
            log('Test de sauvegarde des mappings...', 'info');
            totalTests++;
            
            try {
                // Simuler la sauvegarde
                const testMapping = {
                    device: 'test-device',
                    mappings: { button0: 'fire', button1: 'target' },
                    timestamp: Date.now()
                };
                
                localStorage.setItem('test-mapping', JSON.stringify(testMapping));
                
                // V√©rifier la sauvegarde
                const saved = localStorage.getItem('test-mapping');
                if (saved) {
                    updateTestStatus('save-mapping', 'success', 
                        'Sauvegarde fonctionnelle');
                    log('Sauvegarde et chargement des mappings: OK', 'success');
                } else {
                    throw new Error('Sauvegarde √©chou√©e');
                }
            } catch (error) {
                updateTestStatus('save-mapping', 'error', 
                    'Erreur sauvegarde mappings');
                log(`Erreur sauvegarde: ${error.message}`, 'error');
            }
        }

        async function testUI() {
            log('Test de l\'interface utilisateur...', 'info');
            totalTests++;
            
            try {
                // Tester les √©l√©ments UI critiques
                const criticalElements = [
                    'global-progress',
                    'test-log',
                    'global-status'
                ];
                
                let allElementsPresent = true;
                for (const elementId of criticalElements) {
                    if (!document.getElementById(elementId)) {
                        allElementsPresent = false;
                        break;
                    }
                }
                
                if (allElementsPresent) {
                    updateTestStatus('ui', 'success', 
                        'Interface utilisateur OK');
                    log('Tous les √©l√©ments UI critiques sont pr√©sents', 'success');
                } else {
                    updateTestStatus('ui', 'error', 
                        '√âl√©ments UI manquants');
                    log('Certains √©l√©ments UI critiques sont manquants', 'error');
                }
            } catch (error) {
                updateTestStatus('ui', 'error', 
                    'Erreur test interface');
                log(`Erreur test UI: ${error.message}`, 'error');
            }
        }

        async function runFullValidation() {
            log('D√©marrage de la validation compl√®te du syst√®me...', 'info');
            totalTests++;
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                let validationScore = 0;
                let maxScore = 5;
                
                // V√©rifications syst√®me
                if (navigator.getGamepads) validationScore++;
                if (localStorage) validationScore++;
                if (window.requestAnimationFrame) validationScore++;
                if (document.querySelector) validationScore++;
                if (fetch) validationScore++;
                
                const percentage = (validationScore / maxScore) * 100;
                
                if (percentage >= 80) {
                    updateTestStatus('validation', 'success', 
                        `Validation OK (${percentage}%)`);
                    log(`Validation syst√®me r√©ussie: ${validationScore}/${maxScore} composants OK`, 'success');
                } else if (percentage >= 60) {
                    updateTestStatus('validation', 'warning', 
                        `Validation partielle (${percentage}%)`);
                    log(`Validation partielle: ${validationScore}/${maxScore} composants OK`, 'warning');
                } else {
                    updateTestStatus('validation', 'error', 
                        `Validation √©chou√©e (${percentage}%)`);
                    log(`Validation √©chou√©e: ${validationScore}/${maxScore} composants OK`, 'error');
                }
            } catch (error) {
                updateTestStatus('validation', 'error', 
                    'Erreur validation syst√®me');
                log(`Erreur validation: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            log('=== D√âMARRAGE DE LA SUITE DE TESTS COMPL√àTE ===', 'info');
            
            // R√©initialiser les compteurs
            totalTests = 0;
            completedTests = 0;
            testResults = {};
            
            // Lancer tous les tests
            await testGamepadDetection();
            await testAutoConfiguration();
            await testHatModes();
            await testSaveMapping();
            await testUI();
            await runFullValidation();
            
            log('=== SUITE DE TESTS TERMIN√âE ===', 'info');
            generateSummary();
        }

        function clearAllTests() {
            document.getElementById('test-log').innerHTML = '';
            testResults = {};
            totalTests = 0;
            completedTests = 0;
            updateProgress();
            
            // R√©initialiser tous les statuts
            const statusElements = document.querySelectorAll('[id$="-status"]');
            statusElements.forEach(element => {
                element.textContent = 'Non test√©';
            });
            
            // R√©initialiser les indicateurs
            const indicators = document.querySelectorAll('.status-indicator');
            indicators.forEach(indicator => {
                indicator.className = 'status-indicator status-info';
            });
            
            document.getElementById('results-summary').style.display = 'none';
            log('Tests r√©initialis√©s', 'info');
        }

        function generateSummary() {
            const summaryDiv = document.getElementById('results-summary');
            const contentDiv = document.getElementById('summary-content');
            
            let successCount = 0;
            let warningCount = 0;
            let errorCount = 0;
            
            Object.values(testResults).forEach(result => {
                switch (result.status) {
                    case 'success': successCount++; break;
                    case 'warning': warningCount++; break;
                    case 'error': errorCount++; break;
                }
            });
            
            const total = successCount + warningCount + errorCount;
            const successRate = total > 0 ? Math.round((successCount / total) * 100) : 0;
            
            let summaryClass = 'alert-success';
            if (successRate < 50) summaryClass = 'alert-error';
            else if (successRate < 80) summaryClass = 'alert-warning';
            
            contentDiv.innerHTML = `
                <div class="alert ${summaryClass}">
                    <h3>R√©sultats des tests</h3>
                    <p><strong>Taux de r√©ussite:</strong> ${successRate}%</p>
                    <p><strong>Tests r√©ussis:</strong> ${successCount}</p>
                    <p><strong>Avertissements:</strong> ${warningCount}</p>
                    <p><strong>Erreurs:</strong> ${errorCount}</p>
                </div>
            `;
            
            summaryDiv.style.display = 'block';
        }

        function exportResults() {
            const results = {
                summary: {
                    timestamp: new Date().toISOString(),
                    totalTests: Object.keys(testResults).length,
                    results: testResults
                },
                system: {
                    userAgent: navigator.userAgent,
                    gamepadSupport: !!navigator.getGamepads,
                    localStorageSupport: !!localStorage
                }
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `sc-config-test-results-${Date.now()}.json`;
            link.click();
            
            log('R√©sultats export√©s vers fichier JSON', 'success');
        }

        // Fonctions sp√©cialis√©es (appel√©es par les boutons individuels)
        function runGamepadTest() { window.open('test_gamepad.html', '_blank'); }
        function testConfigButton() { window.open('test_configure_button.html', '_blank'); }
        function testDynamicKeys() { window.open('test_hat_modes.html', '_blank'); }
        function testLoadMapping() { log('Test de chargement des mappings...', 'info'); }
        function testResponsive() { log('Test de la responsivit√© de l\'interface...', 'info'); }
        function generateReport() { window.open('validate_button_fix.html', '_blank'); }

        // Initialisation
        log('Syst√®me de test initialis√© - Pr√™t pour les tests', 'info');
        updateProgress();
    </script>
</body>
</html>
