<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Correction Erreur Device Inconnu</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .log {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .warning-btn {
            background: #ffc107;
            color: #212529;
        }
        .warning-btn:hover {
            background: #e0a800;
        }
    </style>
</head>
<body>
    <h1>üîß Test de Correction - Erreur "Device inconnu non trouv√©"</h1>
    
    <div class="test-container">
        <h2>üìã Description du Test</h2>
        <p>Ce test valide que l'erreur <code>"Device inconnu non trouv√©: 0738_a221"</code> ne s'affiche plus apr√®s un reset de session.</p>
        
        <h3>üéØ Objectifs:</h3>
        <ul>
            <li>‚úÖ Erreur captur√©e gracieusement sans alert()</li>
            <li>‚úÖ Proposition de rechargement de page</li>
            <li>‚úÖ Nettoyage complet des donn√©es c√¥t√© client</li>
            <li>‚úÖ R√©initialisation des modules JavaScript</li>
        </ul>
    </div>

    <div class="test-container">
        <h2>üß™ Simulation de l'Erreur</h2>
        <p>Simulation des conditions qui causaient l'erreur persistante :</p>
        
        <button onclick="simulateOldError()">‚ùå Simuler Ancienne Erreur</button>
        <button onclick="simulateNewBehavior()" class="warning-btn">üîß Tester Nouveau Comportement</button>
        <button onclick="testResetSession()">üîÑ Tester Reset Session</button>
        
        <div id="simulation-log" class="log"></div>
    </div>

    <div class="test-container">
        <h2>üéÆ Test Modules JavaScript</h2>
        <p>Test des modules deviceAutoDetection et deviceAutoDetector :</p>
        
        <button onclick="testModuleCleanup()">üßπ Test Nettoyage Modules</button>
        <button onclick="testStartDeviceSetup()">‚öôÔ∏è Test startDeviceSetup</button>
        <button onclick="clearClientData()" class="danger">üóëÔ∏è Nettoyer Donn√©es Client</button>
        
        <div id="module-log" class="log"></div>
    </div>

    <div class="test-container">
        <h2>üìä Statut de Validation</h2>
        <div id="validation-status">
            <p><span class="info">‚ÑπÔ∏è</span> En attente de tests...</p>
        </div>
    </div>

    <script type="module">
        // Import des modules si disponibles
        let DeviceAutoDetection = null;
        let DeviceAutoDetector = null;
        
        try {
            const moduleDetection = await import('./assets/js/modules/deviceAutoDetection.js');
            DeviceAutoDetection = moduleDetection.DeviceAutoDetection;
            log('‚úÖ Module DeviceAutoDetection charg√©', 'module-log');
        } catch (error) {
            log('‚ö†Ô∏è Module DeviceAutoDetection non disponible: ' + error.message, 'module-log');
        }
        
        try {
            const moduleDetector = await import('./assets/js/modules/deviceAutoDetector.js');
            DeviceAutoDetector = moduleDetector.DeviceAutoDetector;
            log('‚úÖ Module DeviceAutoDetector charg√©', 'module-log');
        } catch (error) {
            log('‚ö†Ô∏è Module DeviceAutoDetector non disponible: ' + error.message, 'module-log');
        }

        // Rendre les fonctions globales
        window.simulateOldError = simulateOldError;
        window.simulateNewBehavior = simulateNewBehavior;
        window.testResetSession = testResetSession;
        window.testModuleCleanup = testModuleCleanup;
        window.testStartDeviceSetup = testStartDeviceSetup;
        window.clearClientData = clearClientData;
    </script>

    <script>
        function log(message, elementId = 'simulation-log') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateValidationStatus(message, type = 'info') {
            const statusElement = document.getElementById('validation-status');
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            statusElement.innerHTML = `<p><span class="${type}">${icons[type]}</span> ${message}</p>`;
        }

        function simulateOldError() {
            log('üî¥ [ANCIEN COMPORTEMENT] Simulation de l\'erreur...', 'simulation-log');
            
            // Simuler l'ancienne erreur qui s'affichait dans un alert()
            try {
                // Simuler recherche d'un dispositif supprim√©
                const deviceKey = '0738_a221';
                const unknownDevices = new Map();
                
                // Pas de dispositif trouv√©
                const deviceInfo = unknownDevices.get(deviceKey);
                if (!deviceInfo) {
                    throw new Error(`Device inconnu non trouv√©: ${deviceKey}`);
                }
            } catch (error) {
                log('‚ùå ANCIENNE VERSION: ' + error.message, 'simulation-log');
                log('‚ùå Cette erreur s\'affichait dans alert() et √©tait intrusive', 'simulation-log');
                updateValidationStatus('Ancien comportement reproduced - Erreur intrusive', 'error');
            }
        }

        function simulateNewBehavior() {
            log('üü¢ [NOUVEAU COMPORTEMENT] Test de la gestion am√©lior√©e...', 'simulation-log');
            
            // Simuler le nouveau comportement am√©lior√©
            function improvedStartDeviceSetup(deviceKey) {
                try {
                    // Simuler la recherche
                    const unknownDevices = new Map();
                    const deviceInfo = unknownDevices.get(deviceKey);
                    if (!deviceInfo) {
                        throw new Error(`Device inconnu non trouv√©: ${deviceKey}`);
                    }
                } catch (error) {
                    // Gestion am√©lior√©e des erreurs
                    if (error.message.includes('Device inconnu non trouv√©')) {
                        console.warn('Tentative de configuration d\'un dispositif supprim√©:', deviceKey);
                        log('‚úÖ NOUVELLE VERSION: Erreur captur√©e gracieusement', 'simulation-log');
                        log('‚úÖ Proposition de rechargement au lieu d\'alert() intrusif', 'simulation-log');
                        
                        // Simulation de la proposition de rechargement
                        const shouldReload = confirm('Ce dispositif n\'est plus disponible. Voulez-vous actualiser la page pour mettre √† jour la liste ?');
                        if (shouldReload) {
                            log('üîÑ Utilisateur a accept√© le rechargement', 'simulation-log');
                        } else {
                            log('‚ùå Utilisateur a refus√© le rechargement', 'simulation-log');
                        }
                        
                        updateValidationStatus('Nouveau comportement valid√© - Gestion gracieuse', 'success');
                        return;
                    }
                    // Autres erreurs
                    alert('Erreur lors du d√©marrage de la configuration: ' + error.message);
                }
            }
            
            improvedStartDeviceSetup('0738_a221');
        }

        function testResetSession() {
            log('üîÑ Test de la fonction resetSession() am√©lior√©e...', 'simulation-log');
            
            // Simuler des donn√©es √† nettoyer
            try {
                // Ajouter des donn√©es de test
                localStorage.setItem('sc_devices', '{"test": "data"}');
                localStorage.setItem('sc_config', '{"config": "test"}');
                localStorage.setItem('device_0738_a221', '{"old": "device"}');
                
                log('üìù Donn√©es de test ajout√©es au localStorage', 'simulation-log');
                
                // Simuler le nettoyage
                function improvedResetSession() {
                    // Nettoyer localStorage
                    localStorage.removeItem('sc_devices');
                    localStorage.removeItem('sc_config');
                    
                    // Nettoyer autres donn√©es si pr√©sentes
                    const scKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('sc_') || key.startsWith('device_'))) {
                            scKeys.push(key);
                        }
                    }
                    scKeys.forEach(key => localStorage.removeItem(key));
                    
                    log('üßπ Donn√©es c√¥t√© client nettoy√©es', 'simulation-log');
                    return scKeys.length;
                }
                
                const cleanedKeys = improvedResetSession();
                log(`‚úÖ ${cleanedKeys} cl√©s nettoy√©es du localStorage`, 'simulation-log');
                updateValidationStatus(`Reset session valid√© - ${cleanedKeys} cl√©s nettoy√©es`, 'success');
                
            } catch (error) {
                log('‚ùå Erreur lors du test de reset: ' + error.message, 'simulation-log');
                updateValidationStatus('Erreur lors du test de reset session', 'error');
            }
        }

        function testModuleCleanup() {
            log('üßπ Test du nettoyage des modules JavaScript...', 'module-log');
            
            // Simuler un module avec des donn√©es
            class MockDeviceAutoDetection {
                constructor() {
                    this.unknownDevices = new Map();
                    this.isSetupMode = false;
                    this.currentSetupDevice = null;
                    
                    // Ajouter des donn√©es de test
                    this.unknownDevices.set('0738_a221', {id: 'saitek_x56'});
                    this.isSetupMode = true;
                    this.currentSetupDevice = {id: 'test'};
                }
                
                clearUnknownDevices() {
                    this.unknownDevices.clear();
                    this.isSetupMode = false;
                    this.currentSetupDevice = null;
                    console.log('üßπ Dispositifs inconnus nettoy√©s');
                }
                
                startDeviceSetup(deviceKey) {
                    const deviceInfo = this.unknownDevices.get(deviceKey);
                    if (!deviceInfo) {
                        throw new Error(`Device inconnu non trouv√©: ${deviceKey}`);
                    }
                    return deviceInfo;
                }
            }
            
            const mockModule = new MockDeviceAutoDetection();
            
            log(`üìä Avant nettoyage: ${mockModule.unknownDevices.size} dispositifs`, 'module-log');
            log(`üìä Setup mode: ${mockModule.isSetupMode}`, 'module-log');
            
            // Tester le nettoyage
            mockModule.clearUnknownDevices();
            
            log(`‚úÖ Apr√®s nettoyage: ${mockModule.unknownDevices.size} dispositifs`, 'module-log');
            log(`‚úÖ Setup mode: ${mockModule.isSetupMode}`, 'module-log');
            
            // Tester que l'erreur ne se produit plus
            try {
                mockModule.startDeviceSetup('0738_a221');
                log('‚ùå Erreur: le dispositif devrait √™tre introuvable', 'module-log');
            } catch (error) {
                log('‚úÖ Dispositif correctement nettoy√©: ' + error.message, 'module-log');
            }
            
            updateValidationStatus('Nettoyage des modules valid√©', 'success');
        }

        function testStartDeviceSetup() {
            log('‚öôÔ∏è Test de la fonction startDeviceSetup am√©lior√©e...', 'module-log');
            
            // Simuler la fonction am√©lior√©e
            function improvedStartDeviceSetup(deviceKey) {
                const mockDetection = {
                    unknownDevices: new Map(),
                    startDeviceSetup: function(key) {
                        const deviceInfo = this.unknownDevices.get(key);
                        if (!deviceInfo) {
                            throw new Error(`Device inconnu non trouv√©: ${key}`);
                        }
                        return deviceInfo;
                    }
                };
                
                if (!mockDetection) {
                    log('‚ùå Syst√®me de d√©tection non initialis√©', 'module-log');
                    return;
                }
                
                try {
                    const deviceInfo = mockDetection.startDeviceSetup(deviceKey);
                    log(`‚úÖ Configuration du dispositif: ${deviceInfo.id}`, 'module-log');
                } catch (error) {
                    // Gestion am√©lior√©e des erreurs
                    if (error.message.includes('Device inconnu non trouv√©')) {
                        log('‚ö†Ô∏è Dispositif supprim√© d√©tect√© gracieusement', 'module-log');
                        log('üîÑ Proposition de rechargement au lieu d\'erreur', 'module-log');
                        updateValidationStatus('startDeviceSetup am√©lior√© valid√©', 'success');
                    } else {
                        log('‚ùå Erreur inattendue: ' + error.message, 'module-log');
                        updateValidationStatus('Erreur inattendue dans startDeviceSetup', 'error');
                    }
                }
            }
            
            // Tester avec un dispositif inexistant
            improvedStartDeviceSetup('0738_a221');
        }

        function clearClientData() {
            log('üóëÔ∏è Nettoyage complet des donn√©es c√¥t√© client...', 'module-log');
            
            let cleaned = 0;
            
            try {
                // Lister toutes les cl√©s avant nettoyage
                const allKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    allKeys.push(localStorage.key(i));
                }
                
                log(`üìã ${allKeys.length} cl√©s trouv√©es dans localStorage`, 'module-log');
                
                // Nettoyer les cl√©s SC-Config
                const scKeys = allKeys.filter(key => 
                    key && (key.startsWith('sc_') || key.startsWith('device_') || key.startsWith('config_'))
                );
                
                scKeys.forEach(key => {
                    localStorage.removeItem(key);
                    cleaned++;
                    log(`üóëÔ∏è Supprim√©: ${key}`, 'module-log');
                });
                
                if (cleaned === 0) {
                    log('‚ÑπÔ∏è Aucune donn√©e SC-Config trouv√©e √† nettoyer', 'module-log');
                } else {
                    log(`‚úÖ ${cleaned} cl√©s nettoy√©es avec succ√®s`, 'module-log');
                }
                
                updateValidationStatus(`Nettoyage complet - ${cleaned} √©l√©ments supprim√©s`, 'success');
                
            } catch (error) {
                log('‚ùå Erreur lors du nettoyage: ' + error.message, 'module-log');
                updateValidationStatus('Erreur lors du nettoyage', 'error');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Test de correction initialis√©', 'simulation-log');
            log('üîß Modules de d√©tection charg√©s', 'module-log');
            updateValidationStatus('Test pr√™t - Tous les outils de validation disponibles', 'info');
        });
    </script>
</body>
</html>
