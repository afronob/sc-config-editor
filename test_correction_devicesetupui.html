<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Correction DeviceSetupUI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007cba; }
        .btn { padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #005a8e; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üîß Test Correction DeviceSetupUI</h1>
    <p>Ce test v√©rifie que les corrections apport√©es au module DeviceSetupUI emp√™chent l'erreur "Cannot read properties of null".</p>

    <div class="test-section">
        <h3>üöÄ Tests de S√©curit√©</h3>
        <button class="btn" onclick="testNullAutoDetection()">Test autoDetection null</button>
        <button class="btn" onclick="testNullUnknownDevices()">Test unknownDevices null</button>
        <button class="btn" onclick="testMissingDevice()">Test device manquant</button>
        <button class="btn" onclick="testNormalOperation()">Test fonctionnement normal</button>
        <button class="btn" onclick="clearLog()">Vider Log</button>
    </div>

    <div class="test-section">
        <h3>üìä R√©sultats des Tests</h3>
        <div id="testResults">
            <p>Aucun test ex√©cut√©</p>
        </div>
    </div>

    <div class="test-section">
        <h3>üìù Log des √âv√©nements</h3>
        <div id="logOutput" class="log">Pr√™t pour les tests...\n</div>
    </div>

    <script type="module">
        import { DeviceSetupUI } from './assets/js/modules/deviceSetupUI.js';

        let testResults = [];

        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logOutput = document.getElementById('logOutput');
            const colors = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            logOutput.textContent += `[${now}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[Test] ${message}`);
        }

        function updateResults() {
            const container = document.getElementById('testResults');
            if (testResults.length === 0) {
                container.innerHTML = '<p>Aucun test ex√©cut√©</p>';
                return;
            }

            let html = '';
            testResults.forEach(result => {
                const statusClass = result.success ? 'success' : 'error';
                const statusText = result.success ? '‚úÖ R√âUSSI' : '‚ùå √âCHOU√â';
                html += `
                    <div class="status ${statusClass}" style="display: block; margin: 5px 0;">
                        ${statusText} ${result.name}: ${result.message}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Test 1: autoDetection null
        window.testNullAutoDetection = function() {
            log('üß™ Test 1: DeviceSetupUI avec autoDetection null', 'info');
            
            try {
                // Cr√©er une instance avec autoDetection null
                const setupUI = new DeviceSetupUI(null, null);
                
                // Tenter d'appeler startSetup
                setupUI.startSetup('test_device_key');
                
                // Si on arrive ici, c'est un probl√®me
                testResults.push({
                    name: 'autoDetection null',
                    success: false,
                    message: 'Erreur attendue non lev√©e'
                });
                log('‚ùå Test 1 √âCHOU√â: Erreur attendue non lev√©e', 'error');
                
            } catch (error) {
                // C'est le comportement attendu
                testResults.push({
                    name: 'autoDetection null',
                    success: true,
                    message: `Erreur captur√©e correctement: ${error.message}`
                });
                log(`‚úÖ Test 1 R√âUSSI: ${error.message}`, 'success');
            }
            
            updateResults();
        };

        // Test 2: unknownDevices null
        window.testNullUnknownDevices = function() {
            log('üß™ Test 2: autoDetection avec unknownDevices null', 'info');
            
            try {
                // Cr√©er un mock autoDetection avec unknownDevices null
                const mockAutoDetection = {
                    unknownDevices: null
                };
                
                const setupUI = new DeviceSetupUI(null, mockAutoDetection);
                setupUI.startSetup('test_device_key');
                
                testResults.push({
                    name: 'unknownDevices null',
                    success: false,
                    message: 'Erreur attendue non lev√©e'
                });
                log('‚ùå Test 2 √âCHOU√â: Erreur attendue non lev√©e', 'error');
                
            } catch (error) {
                testResults.push({
                    name: 'unknownDevices null',
                    success: true,
                    message: `Erreur captur√©e correctement: ${error.message}`
                });
                log(`‚úÖ Test 2 R√âUSSI: ${error.message}`, 'success');
            }
            
            updateResults();
        };

        // Test 3: Device manquant
        window.testMissingDevice = function() {
            log('üß™ Test 3: Device inexistant dans unknownDevices', 'info');
            
            try {
                // Cr√©er un mock autoDetection avec unknownDevices vide
                const mockAutoDetection = {
                    unknownDevices: new Map()
                };
                
                const setupUI = new DeviceSetupUI(null, mockAutoDetection);
                setupUI.startSetup('inexistant_device_key');
                
                testResults.push({
                    name: 'Device manquant',
                    success: false,
                    message: 'Erreur attendue non lev√©e'
                });
                log('‚ùå Test 3 √âCHOU√â: Erreur attendue non lev√©e', 'error');
                
            } catch (error) {
                testResults.push({
                    name: 'Device manquant',
                    success: true,
                    message: `Erreur captur√©e correctement: ${error.message}`
                });
                log(`‚úÖ Test 3 R√âUSSI: ${error.message}`, 'success');
            }
            
            updateResults();
        };

        // Test 4: Fonctionnement normal
        window.testNormalOperation = function() {
            log('üß™ Test 4: Fonctionnement normal avec device valide', 'info');
            
            try {
                // Cr√©er un device factice
                const fakeDevice = {
                    id: 'Test Device',
                    vendor_id: '0x1234',
                    product_id: '0x5678',
                    buttons: 10,
                    axes: 4,
                    gamepad: {
                        id: 'Test Device',
                        axes: [0, 0, 0, 0],
                        buttons: Array(10).fill({ pressed: false, value: 0 })
                    }
                };
                
                // Mock autoDetection avec device
                const mockAutoDetection = {
                    unknownDevices: new Map([['test_device_key', fakeDevice]]),
                    getDeviceKey: (gamepad) => 'test_device_key',
                    onNewDeviceDetected: (callback) => {}
                };
                
                const setupUI = new DeviceSetupUI(null, mockAutoDetection);
                
                // Appeler getDeviceInfo qui utilise notre m√©thode s√©curis√©e
                const deviceInfo = setupUI.getDeviceInfo('test_device_key');
                
                if (deviceInfo && deviceInfo.id === 'Test Device') {
                    testResults.push({
                        name: 'Fonctionnement normal',
                        success: true,
                        message: 'Device r√©cup√©r√© avec succ√®s via getDeviceInfo()'
                    });
                    log(`‚úÖ Test 4 R√âUSSI: Device "${deviceInfo.id}" r√©cup√©r√©`, 'success');
                } else {
                    throw new Error('Device non r√©cup√©r√© correctement');
                }
                
            } catch (error) {
                testResults.push({
                    name: 'Fonctionnement normal',
                    success: false,
                    message: `Erreur inattendue: ${error.message}`
                });
                log(`‚ùå Test 4 √âCHOU√â: ${error.message}`, 'error');
            }
            
            updateResults();
        };

        window.clearLog = function() {
            document.getElementById('logOutput').textContent = 'Log effac√©...\n';
            testResults = [];
            updateResults();
        };

        // Message d'initialisation
        log('üéØ Tests de correction DeviceSetupUI pr√™ts', 'info');
        log('üí° Cliquez sur les boutons de test pour v√©rifier les corrections', 'info');
    </script>
</body>
</html>
