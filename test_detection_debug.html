<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - D√©tection devices au chargement</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        .log-info { background: #e3f2fd; }
        .log-success { background: #e8f5e8; }
        .log-warning { background: #fff3cd; }
        .log-error { background: #f8d7da; }
        .device-info {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007cba;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a8b;
        }
    </style>
</head>
<body>
    <h1>üîç Debug - D√©tection des devices au chargement</h1>
    
    <div class="debug-panel">
        <h2>üìä √âtat du syst√®me</h2>
        <div id="systemStatus">V√©rification en cours...</div>
        
        <h3>üéÆ Devices connect√©s</h3>
        <div id="connectedDevices">Scanning...</div>
        
        <h3>üìã Logs du syst√®me</h3>
        <div id="systemLogs"></div>
        
        <div style="margin-top: 20px;">
            <button class="test-button" onclick="forceDetection()">üîç Forcer la d√©tection</button>
            <button class="test-button" onclick="clearLogs()">üóëÔ∏è Effacer les logs</button>
            <button class="test-button" onclick="showDevicesData()">üìã Afficher devicesDataJs</button>
        </div>
    </div>

    <script type="module">
        // Variables globales pour debug
        window.debugLogs = [];
        window.deviceAutoDetection = null;
        window.deviceSetupUI = null;

        // Override console.log pour capturer les logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            window.debugLogs.push({ timestamp, message, type });
            updateLogsDisplay();
            
            // Appeler la m√©thode originale
            switch(type) {
                case 'error': originalError(message); break;
                case 'warn': originalWarn(message); break;
                default: originalLog(message); break;
            }
        }

        console.log = (...args) => addLog(args.join(' '), 'info');
        console.error = (...args) => addLog(args.join(' '), 'error');
        console.warn = (...args) => addLog(args.join(' '), 'warning');

        function updateLogsDisplay() {
            const container = document.getElementById('systemLogs');
            container.innerHTML = window.debugLogs
                .slice(-20) // Garder seulement les 20 derniers logs
                .map(log => `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`)
                .join('');
            container.scrollTop = container.scrollHeight;
        }

        function updateDevicesDisplay() {
            const container = document.getElementById('connectedDevices');
            const gamepads = navigator.getGamepads();
            let html = '';
            
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    const gp = gamepads[i];
                    html += `
                        <div class="device-info">
                            <strong>Device ${i}:</strong> ${gp.id}<br>
                            <strong>Index:</strong> ${gp.index}<br>
                            <strong>Boutons:</strong> ${gp.buttons.length}<br>
                            <strong>Axes:</strong> ${gp.axes.length}<br>
                            <strong>Connected:</strong> ${gp.connected}
                        </div>
                    `;
                }
            }
            
            if (html === '') {
                html = '<p>‚ùå Aucun device d√©tect√©</p>';
            }
            
            container.innerHTML = html;
        }

        function updateSystemStatus() {
            const status = document.getElementById('systemStatus');
            let statusHTML = '';
            
            statusHTML += `<p><strong>DeviceAutoDetection:</strong> ${window.deviceAutoDetection ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}</p>`;
            statusHTML += `<p><strong>DeviceSetupUI:</strong> ${window.deviceSetupUI ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}</p>`;
            statusHTML += `<p><strong>devicesDataJs:</strong> ${window.devicesDataJs ? `‚úÖ Charg√© (${window.devicesDataJs.length} devices)` : '‚ùå Non charg√©'}</p>`;
            statusHTML += `<p><strong>Gamepad API:</strong> ${navigator.getGamepads ? '‚úÖ Support√©' : '‚ùå Non support√©'}</p>`;
            
            status.innerHTML = statusHTML;
        }

        // Fonctions globales pour les boutons
        window.forceDetection = function() {
            addLog('üîç For√ßage de la d√©tection...', 'info');
            if (window.deviceAutoDetection) {
                window.deviceAutoDetection.checkExistingGamepads();
                addLog('‚úÖ checkExistingGamepads() appel√©', 'success');
            } else {
                addLog('‚ùå DeviceAutoDetection non disponible', 'error');
            }
            updateDevicesDisplay();
        };

        window.clearLogs = function() {
            window.debugLogs = [];
            updateLogsDisplay();
        };

        window.showDevicesData = function() {
            if (window.devicesDataJs) {
                addLog(`üìã devicesDataJs contient ${window.devicesDataJs.length} devices:`, 'info');
                window.devicesDataJs.slice(0, 5).forEach((device, index) => {
                    addLog(`  ${index + 1}. ${device.id} (${device.vendor_id}/${device.product_id})`, 'info');
                });
                if (window.devicesDataJs.length > 5) {
                    addLog(`  ... et ${window.devicesDataJs.length - 5} autres`, 'info');
                }
            } else {
                addLog('‚ùå devicesDataJs non disponible', 'error');
            }
        };

        // Initialisation
        async function init() {
            addLog('üöÄ Initialisation du debug...', 'info');
            
            try {
                // Charger les donn√©es des devices
                addLog('üì• Chargement des donn√©es devices...', 'info');
                const response = await fetch('get_devices_data.php');
                const devicesData = await response.json();
                window.devicesDataJs = devicesData;
                addLog(`‚úÖ ${devicesData.length} devices charg√©s`, 'success');
                
                // Initialiser DeviceAutoDetection
                addLog('üîß Initialisation DeviceAutoDetection...', 'info');
                const { DeviceAutoDetection } = await import('./assets/js/modules/deviceAutoDetection.js');
                window.deviceAutoDetection = new DeviceAutoDetection();
                addLog('‚úÖ DeviceAutoDetection initialis√©', 'success');
                
                // Initialiser DeviceSetupUI
                addLog('üé® Initialisation DeviceSetupUI...', 'info');
                const { DeviceSetupUI } = await import('./assets/js/modules/deviceSetupUI.js');
                window.deviceSetupUI = new DeviceSetupUI(window.deviceAutoDetection);
                addLog('‚úÖ DeviceSetupUI initialis√©', 'success');
                
                addLog('üéâ Initialisation termin√©e!', 'success');
                addLog('üîç D√©tection automatique des devices existants...', 'info');
                
            } catch (error) {
                addLog(`‚ùå Erreur d'initialisation: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
            }
            
            updateSystemStatus();
            updateDevicesDisplay();
        }

        // D√©marrer l'initialisation
        init();

        // Mettre √† jour l'affichage toutes les 2 secondes
        setInterval(() => {
            updateSystemStatus();
            updateDevicesDisplay();
        }, 2000);

        // √âcouter les √©v√©nements gamepad
        window.addEventListener('gamepadconnected', (e) => {
            addLog(`üéÆ Device connect√©: ${e.gamepad.id}`, 'success');
            updateDevicesDisplay();
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            addLog(`üéÆ Device d√©connect√©: ${e.gamepad.id}`, 'warning');
            updateDevicesDisplay();
        });

        // √âcouter l'√©v√©nement personnalis√© de d√©tection
        window.addEventListener('unknownDeviceDetected', (e) => {
            addLog(`üîî Nouveau device d√©tect√©: ${e.detail.id}`, 'success');
        });
    </script>
</body>
</html>
