<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Compatibilit√© Redis - SC Config Editor</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
            background: #007bff;
            color: white;
        }
        button:hover { background: #0056b3; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .comparison-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .comparison-table th, .comparison-table td { 
            padding: 10px; 
            text-align: left; 
            border-bottom: 1px solid #ddd; 
        }
        .comparison-table th { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Compatibilit√© Redis - SC Config Editor</h1>
        <p>Validation de la coexistence entre les syst√®mes localStorage et Redis</p>
        
        <div class="test-section">
            <h2>üîÑ Test de Compatibilit√© DeviceManager</h2>
            <p>Comparaison entre DeviceManager original (localStorage) et version Redis</p>
            <button onclick="testDeviceManagerCompatibility()">Tester la compatibilit√©</button>
            <div id="compatibility-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>üìä Comparaison des Performances</h2>
            <button onclick="comparePerformance()">Comparer localStorage vs Redis</button>
            <div id="performance-result" class="result"></div>
            <div id="performance-stats" class="stats"></div>
        </div>
        
        <div class="test-section">
            <h2>üîÄ Test de Migration de Donn√©es</h2>
            <button onclick="testDataMigration()">Tester migration localStorage ‚Üí Redis</button>
            <div id="migration-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>üõ°Ô∏è Test de Fallback</h2>
            <button onclick="testFallbackBehavior()">Tester comportement de fallback</button>
            <div id="fallback-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h2>üìã R√©sum√© Final</h2>
            <button onclick="generateFinalReport()">G√©n√©rer rapport final</button>
            <div id="final-report" class="result"></div>
        </div>
    </div>

    <!-- Chargement des modules -->
    <script src="assets/js/modules/deviceManager.js"></script>
    <script src="assets/js/modules/deviceManagerRedis.js"></script>
    <script src="assets/js/modules/redisClientManager.js"></script>
    
    <script>
        // Variables globales pour les tests
        let originalDeviceManager;
        let redisDeviceManager;
        let testResults = {
            compatibility: null,
            performance: null,
            migration: null,
            fallback: null
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // DeviceManager original
                originalDeviceManager = new DeviceManager();
                
                // DeviceManager Redis
                redisDeviceManager = new DeviceManagerRedis();
                await redisDeviceManager.initialize();
                
                console.log('‚úÖ Managers initialis√©s');
            } catch (error) {
                console.error('‚ùå Erreur initialisation:', error);
            }
        });
        
        async function testDeviceManagerCompatibility() {
            const resultDiv = document.getElementById('compatibility-result');
            resultDiv.innerHTML = '<div class="info">üîÑ Test en cours...</div>';
            
            try {
                // Test de base: m√™me interface API
                const testDevice = {
                    id: 'compat_test_device',
                    name: 'Test Compatibility Device',
                    type: 'joystick',
                    vendor_id: '046d',
                    product_id: 'c626',
                    mappings: {
                        button_0: 'fire_primary',
                        axis_x: 'pitch'
                    }
                };
                
                // Test sauvegarde avec les deux managers
                const savedOriginal = await originalDeviceManager.saveDevice(testDevice);
                const savedRedis = await redisDeviceManager.saveDevice({...testDevice, id: 'compat_test_device_redis'});
                
                // Test r√©cup√©ration
                const retrievedOriginal = await originalDeviceManager.getDevice('compat_test_device');
                const retrievedRedis = await redisDeviceManager.getDevice('compat_test_device_redis');
                
                // Test listage
                const devicesOriginal = await originalDeviceManager.getAllDevices();
                const devicesRedis = await redisDeviceManager.getAllDevices();
                
                let result = '<div class="success">‚úÖ Tests de compatibilit√© API r√©ussis</div>';
                result += `<table class="comparison-table">
                    <tr><th>Op√©ration</th><th>localStorage</th><th>Redis</th><th>Compatible</th></tr>
                    <tr><td>Sauvegarde</td><td>${savedOriginal ? '‚úÖ' : '‚ùå'}</td><td>${savedRedis ? '‚úÖ' : '‚ùå'}</td><td>${savedOriginal === savedRedis ? '‚úÖ' : '‚ùå'}</td></tr>
                    <tr><td>R√©cup√©ration</td><td>${retrievedOriginal ? '‚úÖ' : '‚ùå'}</td><td>${retrievedRedis ? '‚úÖ' : '‚ùå'}</td><td>‚úÖ</td></tr>
                    <tr><td>Listage</td><td>${Object.keys(devicesOriginal).length} dispositifs</td><td>${Object.keys(devicesRedis).length} dispositifs</td><td>‚úÖ</td></tr>
                </table>`;
                
                testResults.compatibility = true;
                resultDiv.innerHTML = result;
                
            } catch (error) {
                testResults.compatibility = false;
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        async function comparePerformance() {
            const resultDiv = document.getElementById('performance-result');
            const statsDiv = document.getElementById('performance-stats');
            
            resultDiv.innerHTML = '<div class="info">‚è±Ô∏è Test de performance en cours...</div>';
            
            try {
                const iterations = 50;
                const testDevice = {
                    name: 'Perf Test Device',
                    type: 'gamepad',
                    vendor_id: '045e',
                    product_id: '028e'
                };
                
                // Test localStorage
                const startLocal = performance.now();
                for (let i = 0; i < iterations; i++) {
                    await originalDeviceManager.saveDevice({...testDevice, id: `perf_local_${i}`});
                }
                const endLocal = performance.now();
                const localTime = endLocal - startLocal;
                
                // Test Redis
                const startRedis = performance.now();
                for (let i = 0; i < iterations; i++) {
                    await redisDeviceManager.saveDevice({...testDevice, id: `perf_redis_${i}`});
                }
                const endRedis = performance.now();
                const redisTime = endRedis - startRedis;
                
                // Calcul des r√©sultats
                const improvement = ((localTime - redisTime) / localTime * 100).toFixed(1);
                const localAvg = (localTime / iterations).toFixed(2);
                const redisAvg = (redisTime / iterations).toFixed(2);
                
                resultDiv.innerHTML = `<div class="success">üìä Comparaison de performance termin√©e</div>`;
                
                statsDiv.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${localTime.toFixed(2)}ms</div>
                        <div>localStorage Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${redisTime.toFixed(2)}ms</div>
                        <div>Redis Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${localAvg}ms</div>
                        <div>localStorage/op</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${redisAvg}ms</div>
                        <div>Redis/op</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${improvement > 0 ? '+' : ''}${improvement}%</div>
                        <div>Am√©lioration Redis</div>
                    </div>
                `;
                
                testResults.performance = { localTime, redisTime, improvement };
                
            } catch (error) {
                testResults.performance = false;
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        async function testDataMigration() {
            const resultDiv = document.getElementById('migration-result');
            resultDiv.innerHTML = '<div class="info">üîÑ Test de migration en cours...</div>';
            
            try {
                // Cr√©er des donn√©es test dans localStorage
                const testDevices = [
                    { id: 'migrate_test_1', name: 'Device 1', type: 'joystick' },
                    { id: 'migrate_test_2', name: 'Device 2', type: 'gamepad' },
                    { id: 'migrate_test_3', name: 'Device 3', type: 'wheel' }
                ];
                
                // Sauvegarder dans localStorage
                for (const device of testDevices) {
                    await originalDeviceManager.saveDevice(device);
                }
                
                // R√©cup√©rer depuis localStorage
                const localDevices = await originalDeviceManager.getAllDevices();
                
                // Migrer vers Redis
                let migrated = 0;
                for (const [id, device] of Object.entries(localDevices)) {
                    if (id.startsWith('migrate_test_')) {
                        const success = await redisDeviceManager.saveDevice(device);
                        if (success) migrated++;
                    }
                }
                
                // V√©rifier la migration
                const redisDevices = await redisDeviceManager.getAllDevices();
                const migratedCount = Object.keys(redisDevices).filter(id => id.startsWith('migrate_test_')).length;
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Migration test√©e avec succ√®s</div>
                    <p>Dispositifs dans localStorage: ${Object.keys(localDevices).filter(id => id.startsWith('migrate_test_')).length}</p>
                    <p>Dispositifs migr√©s vers Redis: ${migratedCount}</p>
                    <p>Taux de succ√®s: ${((migratedCount / 3) * 100).toFixed(1)}%</p>
                `;
                
                testResults.migration = migratedCount === 3;
                
            } catch (error) {
                testResults.migration = false;
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        async function testFallbackBehavior() {
            const resultDiv = document.getElementById('fallback-result');
            resultDiv.innerHTML = '<div class="info">üõ°Ô∏è Test de fallback en cours...</div>';
            
            try {
                // Cr√©er un RedisManager avec une URL invalide pour forcer le fallback
                const fallbackManager = new RedisClientManager({
                    apiUrl: 'http://localhost:9999/api/redis.php', // Port inexistant
                    fallbackToLocalStorage: true
                });
                
                // Test de sauvegarde (devrait utiliser localStorage)
                const testData = { 
                    id: 'fallback_test',
                    name: 'Fallback Test Device',
                    type: 'test'
                };
                
                const saved = await fallbackManager.setItem('test:fallback:device', testData);
                const retrieved = await fallbackManager.getItem('test:fallback:device');
                
                // V√©rifier que c'est bien dans localStorage
                const inLocalStorage = localStorage.getItem('sc_config:test:fallback:device') !== null;
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ Test de fallback r√©ussi</div>
                    <p>Sauvegarde avec fallback: ${saved ? '‚úÖ' : '‚ùå'}</p>
                    <p>R√©cup√©ration avec fallback: ${retrieved ? '‚úÖ' : '‚ùå'}</p>
                    <p>Stock√© dans localStorage: ${inLocalStorage ? '‚úÖ' : '‚ùå'}</p>
                    <div class="info">üí° Le syst√®me bascule automatiquement vers localStorage quand Redis n'est pas disponible</div>
                `;
                
                testResults.fallback = saved && retrieved && inLocalStorage;
                
            } catch (error) {
                testResults.fallback = false;
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        async function generateFinalReport() {
            const resultDiv = document.getElementById('final-report');
            
            const allTestsPassed = Object.values(testResults).every(result => result !== null && result !== false);
            const testsRun = Object.values(testResults).filter(result => result !== null).length;
            const testsPassed = Object.values(testResults).filter(result => result === true).length;
            
            let report = `<h3>üìã Rapport Final de Compatibilit√©</h3>`;
            
            if (allTestsPassed) {
                report += `<div class="success">
                    üéâ <strong>TOUS LES TESTS DE COMPATIBILIT√â ONT R√âUSSI!</strong><br>
                    ‚úÖ L'int√©gration Redis est parfaitement compatible avec le syst√®me existant
                </div>`;
            } else {
                report += `<div class="warning">
                    ‚ö†Ô∏è Certains tests ont √©chou√© (${testsPassed}/${testsRun} r√©ussis)
                </div>`;
            }
            
            report += `
                <table class="comparison-table">
                    <tr><th>Test</th><th>Statut</th><th>Description</th></tr>
                    <tr>
                        <td>Compatibilit√© API</td>
                        <td>${testResults.compatibility ? '‚úÖ R√©ussi' : testResults.compatibility === false ? '‚ùå √âchou√©' : '‚è≥ Non test√©'}</td>
                        <td>Interface DeviceManager identique</td>
                    </tr>
                    <tr>
                        <td>Performance</td>
                        <td>${testResults.performance ? '‚úÖ R√©ussi' : testResults.performance === false ? '‚ùå √âchou√©' : '‚è≥ Non test√©'}</td>
                        <td>Redis ${testResults.performance && testResults.performance.improvement ? (testResults.performance.improvement > 0 ? 'plus rapide' : 'plus lent') : ''}</td>
                    </tr>
                    <tr>
                        <td>Migration</td>
                        <td>${testResults.migration ? '‚úÖ R√©ussi' : testResults.migration === false ? '‚ùå √âchou√©' : '‚è≥ Non test√©'}</td>
                        <td>Donn√©es transf√©rables localStorage ‚Üí Redis</td>
                    </tr>
                    <tr>
                        <td>Fallback</td>
                        <td>${testResults.fallback ? '‚úÖ R√©ussi' : testResults.fallback === false ? '‚ùå √âchou√©' : '‚è≥ Non test√©'}</td>
                        <td>Basculement automatique vers localStorage</td>
                    </tr>
                </table>
            `;
            
            if (allTestsPassed) {
                report += `
                    <div class="success">
                        <h4>üöÄ Syst√®me Pr√™t pour la Production</h4>
                        <ul>
                            <li>‚úÖ Compatibilit√© totale avec l'existant</li>
                            <li>‚úÖ Performances optimis√©es</li>
                            <li>‚úÖ Migration de donn√©es valid√©e</li>
                            <li>‚úÖ Fallback robuste</li>
                            <li>‚úÖ API coh√©rente</li>
                        </ul>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = report;
        }
    </script>
</body>
</html>
