<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagnostic des filtres</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .diagnostic { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .filter-section { background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîç Diagnostic du syst√®me de filtres</h1>
    
    <div class="diagnostic info">
        <h3>üìã √âtapes de diagnostic</h3>
        <ol>
            <li>V√©rifier que les √©l√©ments de filtre existent</li>
            <li>V√©rifier que la table existe</li>
            <li>V√©rifier la structure des lignes</li>
            <li>Tester la logique de filtrage</li>
            <li>V√©rifier les event listeners</li>
        </ol>
    </div>

    <!-- Reproduction exacte de la structure attendue -->
    <div class="filter-section">
        <h3>Filtres (reproduction exacte)</h3>
        <label><input type="checkbox" id="filter-nonempty"> Afficher seulement les bindings non vides</label><br>
        <label><input type="checkbox" id="filter-hold"> Afficher seulement les inputs en mode Hold</label>
    </div>

    <!-- Table de test avec structure exacte du template PHP -->
    <table id="bindings-table">
        <tr>
            <th>category</th>
            <th>action</th>
            <th>name</th>
            <th>input</th>
            <th>opts</th>
            <th>value</th>
        </tr>
        <!-- Test case 1: Empty binding -->
        <tr>
            <td>spaceship_movement</td>
            <td>v_pitch</td>
            <td>Tangage</td>
            <td><input name="input[spaceship_movement][v_pitch][0]" value="" /></td>
            <td><input name="opts[spaceship_movement][v_pitch][0]" value="" /></td>
            <td><input name="value[spaceship_movement][v_pitch][0]" value="" /></td>
        </tr>
        <!-- Test case 2: Hold mode binding -->
        <tr>
            <td>spaceship_movement</td>
            <td>v_roll</td>
            <td>Roulis</td>
            <td><input name="input[spaceship_movement][v_roll][0]" value="js1_button2" /></td>
            <td><input name="opts[spaceship_movement][v_roll][0]" value="activationmode" /></td>
            <td><input name="value[spaceship_movement][v_roll][0]" value="hold" /></td>
        </tr>
        <!-- Test case 3: Normal binding -->
        <tr>
            <td>spaceship_movement</td>
            <td>v_yaw</td>
            <td>Lacet</td>
            <td><input name="input[spaceship_movement][v_yaw][0]" value="js1_button1" /></td>
            <td><input name="opts[spaceship_movement][v_yaw][0]" value="activationmode" /></td>
            <td><input name="value[spaceship_movement][v_yaw][0]" value="press" /></td>
        </tr>
        <!-- Test case 4: Prefix only (empty) -->
        <tr>
            <td>spaceship_movement</td>
            <td>v_strafe_forward</td>
            <td>Avancer</td>
            <td><input name="input[spaceship_movement][v_strafe_forward][0]" value="js1_" /></td>
            <td><input name="opts[spaceship_movement][v_strafe_forward][0]" value="" /></td>
            <td><input name="value[spaceship_movement][v_strafe_forward][0]" value="" /></td>
        </tr>
    </table>

    <button onclick="runDiagnostic()">üîç Lancer le diagnostic</button>
    <button onclick="clearResults()">üßπ Effacer les r√©sultats</button>

    <div id="diagnostic-results"></div>

    <script type="module">
        import { FilterHandler } from '/assets/js/modules/filterHandler.js';
        
        let filterHandler;
        let results = [];
        
        // Fonction de diagnostic globale
        window.runDiagnostic = function() {
            results = [];
            addResult('üöÄ D√©marrage du diagnostic...', 'info');
            
            // Test 1: V√©rifier l'existence des √©l√©ments
            test1CheckElements();
            
            // Test 2: Initialiser FilterHandler
            test2InitializeHandler();
            
            // Test 3: Tester les s√©lecteurs
            test3TestSelectors();
            
            // Test 4: Tester la logique de filtrage
            test4TestFilterLogic();
            
            // Test 5: Tester les event listeners
            test5TestEventListeners();
            
            addResult('‚úÖ Diagnostic termin√©', 'success');
        };
        
        window.clearResults = function() {
            document.getElementById('diagnostic-results').innerHTML = '';
            results = [];
        };
        
        function test1CheckElements() {
            addResult('Test 1: V√©rification des √©l√©ments DOM', 'info');
            
            const filterNonEmpty = document.getElementById('filter-nonempty');
            const filterHold = document.getElementById('filter-hold');
            const table = document.getElementById('bindings-table');
            
            if (filterNonEmpty) {
                addResult('‚úÖ √âl√©ment filter-nonempty trouv√©', 'success');
            } else {
                addResult('‚ùå √âl√©ment filter-nonempty manquant', 'error');
            }
            
            if (filterHold) {
                addResult('‚úÖ √âl√©ment filter-hold trouv√©', 'success');
            } else {
                addResult('‚ùå √âl√©ment filter-hold manquant', 'error');
            }
            
            if (table) {
                addResult(`‚úÖ Table trouv√©e avec ${table.rows.length} lignes`, 'success');
            } else {
                addResult('‚ùå Table bindings-table manquante', 'error');
            }
        }
        
        function test2InitializeHandler() {
            addResult('Test 2: Initialisation de FilterHandler', 'info');
            
            try {
                filterHandler = new FilterHandler();
                addResult('‚úÖ FilterHandler initialis√© avec succ√®s', 'success');
                
                // V√©rifier les m√©thodes
                if (typeof filterHandler.isBindingEmpty === 'function') {
                    addResult('‚úÖ M√©thode isBindingEmpty trouv√©e', 'success');
                } else {
                    addResult('‚ùå M√©thode isBindingEmpty manquante', 'error');
                }
                
                if (typeof filterHandler.isHoldModeBinding === 'function') {
                    addResult('‚úÖ M√©thode isHoldModeBinding trouv√©e', 'success');
                } else {
                    addResult('‚ùå M√©thode isHoldModeBinding manquante', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Erreur lors de l'initialisation: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function test3TestSelectors() {
            addResult('Test 3: Test des s√©lecteurs CSS', 'info');
            
            const table = document.getElementById('bindings-table');
            if (!table) {
                addResult('‚ùå Table non trouv√©e pour les tests de s√©lecteurs', 'error');
                return;
            }
            
            const rows = Array.from(table.rows).slice(1); // Skip header
            addResult(`üìä ${rows.length} lignes de donn√©es trouv√©es`, 'info');
            
            rows.forEach((row, idx) => {
                const inputCell = row.querySelector('input[name^="input["]');
                const optsCell = row.querySelector('input[name^="opts["]');
                const valueCell = row.querySelector('input[name^="value["]');
                
                const hasInput = inputCell ? '‚úÖ' : '‚ùå';
                const hasOpts = optsCell ? '‚úÖ' : '‚ùå';
                const hasValue = valueCell ? '‚úÖ' : '‚ùå';
                
                addResult(`Ligne ${idx + 1}: Input ${hasInput} Opts ${hasOpts} Value ${hasValue}`, 
                         (hasInput === '‚úÖ' && hasOpts === '‚úÖ' && hasValue === '‚úÖ') ? 'success' : 'warning');
                
                if (inputCell && optsCell && valueCell) {
                    const inputVal = inputCell.value;
                    const optsVal = optsCell.value;
                    const valueVal = valueCell.value;
                    
                    addResult(`  ‚îî‚îÄ Input: "${inputVal}", Opts: "${optsVal}", Value: "${valueVal}"`, 'info');
                }
            });
        }
        
        function test4TestFilterLogic() {
            addResult('Test 4: Test de la logique de filtrage', 'info');
            
            if (!filterHandler) {
                addResult('‚ùå FilterHandler non initialis√©', 'error');
                return;
            }
            
            // Test isBindingEmpty
            const emptyTests = [
                { value: '', expected: true, description: 'Cha√Æne vide' },
                { value: 'js1_', expected: true, description: 'Pr√©fixe seul' },
                { value: 'kb1_', expected: true, description: 'Pr√©fixe clavier' },
                { value: 'mo_', expected: true, description: 'Pr√©fixe mouse' },
                { value: 'js1_button1', expected: false, description: 'Binding valide' },
            ];
            
            emptyTests.forEach(test => {
                try {
                    const result = filterHandler.isBindingEmpty(test.value);
                    const status = result === test.expected ? '‚úÖ' : '‚ùå';
                    addResult(`${status} isBindingEmpty("${test.value}") = ${result} (${test.description})`, 
                             result === test.expected ? 'success' : 'error');
                } catch (error) {
                    addResult(`‚ùå Erreur avec isBindingEmpty("${test.value}"): ${error.message}`, 'error');
                }
            });
            
            // Test isHoldModeBinding
            const holdTests = [
                { opts: 'activationmode', value: 'hold', expected: true, description: 'Hold mode normal' },
                { opts: 'activationmode', value: 'HOLD', expected: true, description: 'Hold mode majuscules' },
                { opts: 'activationmode', value: 'press', expected: false, description: 'Press mode' },
                { opts: '', value: 'hold', expected: false, description: 'Hold sans activationmode' },
                { opts: 'other', value: 'hold', expected: false, description: 'Autre opts' },
            ];
            
            holdTests.forEach(test => {
                try {
                    const result = filterHandler.isHoldModeBinding(test.opts, test.value);
                    const status = result === test.expected ? '‚úÖ' : '‚ùå';
                    addResult(`${status} isHoldModeBinding("${test.opts}", "${test.value}") = ${result} (${test.description})`, 
                             result === test.expected ? 'success' : 'error');
                } catch (error) {
                    addResult(`‚ùå Erreur avec isHoldModeBinding: ${error.message}`, 'error');
                }
            });
        }
        
        function test5TestEventListeners() {
            addResult('Test 5: Test des event listeners', 'info');
            
            const filterNonEmpty = document.getElementById('filter-nonempty');
            const filterHold = document.getElementById('filter-hold');
            
            if (filterNonEmpty) {
                // Tester le changement de filtre
                filterNonEmpty.checked = true;
                filterNonEmpty.dispatchEvent(new Event('change'));
                addResult('‚úÖ Event change envoy√© sur filter-nonempty', 'success');
                
                filterNonEmpty.checked = false;
                filterNonEmpty.dispatchEvent(new Event('change'));
            }
            
            if (filterHold) {
                filterHold.checked = true;
                filterHold.dispatchEvent(new Event('change'));
                addResult('‚úÖ Event change envoy√© sur filter-hold', 'success');
                
                filterHold.checked = false;
                filterHold.dispatchEvent(new Event('change'));
            }
        }
        
        function addResult(message, type = 'info') {
            results.push({ message, type, timestamp: new Date().toLocaleTimeString() });
            displayResults();
        }
        
        function displayResults() {
            const container = document.getElementById('diagnostic-results');
            container.innerHTML = '';
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `diagnostic ${result.type}`;
                div.innerHTML = `
                    <strong>[${result.timestamp}]</strong> ${result.message}
                `;
                container.appendChild(div);
            });
        }
        
        console.log('üîç Diagnostic des filtres initialis√©');
        console.log('Utilisez runDiagnostic() pour lancer le diagnostic complet');
    </script>
</body>
</html>
