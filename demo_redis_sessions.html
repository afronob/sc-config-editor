<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Stockage Redis - Sessions Step-by-Step</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 5px solid #007bff;
        }
        .test-results {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.secondary {
            background: #6c757d;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        .status {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .workflow {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        .step {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            text-align: center;
        }
        .step.active {
            border-color: #007bff;
            background: #f8f9ff;
        }
        .step.completed {
            border-color: #28a745;
            background: #f8fff9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ D√©monstration du Stockage Redis</h1>
            <h2>Sessions Step-by-Step pour Star Citizen Config Editor</h2>
            <p>Test du syst√®me de stockage hybride Redis + Sessions PHP</p>
        </div>

        <div class="workflow">
            <div class="step" id="step1">
                <h3>1Ô∏è‚É£ √âtape 1</h3>
                <p>Upload XML</p>
                <button class="button" onclick="simulateStep1()">üîÑ Simuler Upload</button>
            </div>
            <div class="step" id="step2">
                <h3>2Ô∏è‚É£ √âtape 2</h3>
                <p>D√©tection Devices</p>
                <button class="button" onclick="simulateStep2()">üéÆ D√©tecter Devices</button>
            </div>
            <div class="step" id="step3">
                <h3>3Ô∏è‚É£ √âtape 3</h3>
                <p>√âdition Config</p>
                <button class="button" onclick="simulateStep3()">‚úèÔ∏è √âditer Config</button>
            </div>
            <div class="step" id="step4">
                <h3>4Ô∏è‚É£ √âtape 4</h3>
                <p>T√©l√©chargement</p>
                <button class="button" onclick="simulateStep4()">‚¨áÔ∏è T√©l√©charger</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üîç √âtat du Stockage Redis</h3>
            <div class="status" id="redis-status">üîÑ V√©rification...</div>
            <button class="button" onclick="checkRedisStatus()">üìä V√©rifier Redis</button>
            <button class="button secondary" onclick="viewRedisKeys()">üîë Voir les Cl√©s</button>
            <button class="button danger" onclick="clearRedisData()">üóëÔ∏è Nettoyer</button>
        </div>

        <div class="test-section">
            <h3>üìä Donn√©es de Session</h3>
            <div id="session-data" class="test-results">Aucune donn√©e de session charg√©e</div>
            <button class="button" onclick="loadSessionData()">üìñ Charger Donn√©es</button>
            <button class="button secondary" onclick="simulateFullWorkflow()">üöÄ Workflow Complet</button>
        </div>

        <div class="test-section">
            <h3>üìã Journal des Op√©rations</h3>
            <div id="operation-log" class="test-results">Pr√™t pour les tests...\n</div>
            <button class="button secondary" onclick="clearLog()">üßπ Effacer Log</button>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let sessionData = {};

        function log(message) {
            const logDiv = document.getElementById('operation-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(element, message, type = 'info') {
            const statusDiv = document.getElementById(element);
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        async function checkRedisStatus() {
            log('üîç V√©rification du statut Redis...');
            try {
                const response = await fetch('/api/redis.php/status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.connected) {
                        updateStatus('redis-status', '‚úÖ Redis connect√© et op√©rationnel', 'success');
                        log('‚úÖ Redis Status: Connect√©');
                    } else {
                        updateStatus('redis-status', '‚ùå Redis d√©connect√©', 'error');
                        log('‚ùå Redis Status: D√©connect√©');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('redis-status', '‚ùå Erreur de connexion Redis', 'error');
                log(`‚ùå Erreur Redis: ${error.message}`);
            }
        }

        async function viewRedisKeys() {
            log('üîë R√©cup√©ration des cl√©s Redis...');
            try {
                const response = await fetch('/api/redis.php/stats');
                if (response.ok) {
                    const data = await response.json();
                    log(`üìä Statistics Redis:`);
                    log(`  - Devices: ${data.devices || 0}`);
                    log(`  - Sessions: ${data.sessions || 0}`);
                    log(`  - Configs temporaires: ${data.temp_configs || 0}`);
                    log(`  - Cache XML: ${data.xml_cache || 0}`);
                    
                    document.getElementById('session-data').textContent = JSON.stringify(data, null, 2);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur r√©cup√©ration cl√©s: ${error.message}`);
            }
        }

        async function simulateStep1() {
            log('üì§ Simulation √âtape 1: Upload XML...');
            document.getElementById('step1').className = 'step active';
            
            // Simuler l'upload d'un XML
            const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<ActionMaps version="1" optionsVersion="2" rebindVersion="2" profileName="test_redis_demo">
    <actionmap name="spaceship_movement">
        <action name="v_pitch">
            <rebind input="js1_x"/>
        </action>
    </actionmap>
</ActionMaps>`;

            try {
                // Sauvegarder dans Redis via l'API
                const response = await fetch('/api/redis.php/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: `sessions:stepbystep:demo_${Date.now()}`,
                        value: {
                            currentStep: 1,
                            xmlData: xmlContent,
                            xmlName: 'test_redis_demo.xml',
                            devices: [],
                            modifications: [],
                            created_at: new Date().toISOString()
                        }
                    })
                });

                if (response.ok) {
                    document.getElementById('step1').className = 'step completed';
                    log('‚úÖ √âtape 1 termin√©e - XML stock√© dans Redis');
                    currentStep = 2;
                    sessionData.xmlData = xmlContent;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur √âtape 1: ${error.message}`);
            }
        }

        async function simulateStep2() {
            if (currentStep < 2) {
                log('‚ö†Ô∏è Veuillez d\'abord terminer l\'√âtape 1');
                return;
            }

            log('üéÆ Simulation √âtape 2: D√©tection des dispositifs...');
            document.getElementById('step2').className = 'step active';

            // Simuler la d√©tection de dispositifs
            const devices = [
                { name: 'VKB Gladiator NXT', type: 'joystick', instance: 1 },
                { name: 'Thrustmaster T16000M', type: 'joystick', instance: 2 }
            ];

            sessionData.devices = devices;
            sessionData.currentStep = 2;

            try {
                // Mettre √† jour dans Redis
                const response = await fetch('/api/redis.php/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: `sessions:stepbystep:demo_current`,
                        value: sessionData
                    })
                });

                if (response.ok) {
                    document.getElementById('step2').className = 'step completed';
                    log('‚úÖ √âtape 2 termin√©e - Dispositifs d√©tect√©s et stock√©s');
                    log(`  - ${devices.length} dispositifs trouv√©s`);
                    currentStep = 3;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur √âtape 2: ${error.message}`);
            }
        }

        async function simulateStep3() {
            if (currentStep < 3) {
                log('‚ö†Ô∏è Veuillez d\'abord terminer les √©tapes pr√©c√©dentes');
                return;
            }

            log('‚úèÔ∏è Simulation √âtape 3: √âdition de la configuration...');
            document.getElementById('step3').className = 'step active';

            // Simuler des modifications
            const modifications = [
                { action: 'v_pitch', device: 'js1', input: 'js1_x', timestamp: Date.now() },
                { action: 'v_yaw', device: 'js1', input: 'js1_y', timestamp: Date.now() }
            ];

            sessionData.modifications = modifications;
            sessionData.currentStep = 3;

            try {
                const response = await fetch('/api/redis.php/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: `sessions:stepbystep:demo_current`,
                        value: sessionData
                    })
                });

                if (response.ok) {
                    document.getElementById('step3').className = 'step completed';
                    log('‚úÖ √âtape 3 termin√©e - Configuration √©dit√©e');
                    log(`  - ${modifications.length} modifications apport√©es`);
                    currentStep = 4;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur √âtape 3: ${error.message}`);
            }
        }

        async function simulateStep4() {
            if (currentStep < 4) {
                log('‚ö†Ô∏è Veuillez d\'abord terminer les √©tapes pr√©c√©dentes');
                return;
            }

            log('‚¨áÔ∏è Simulation √âtape 4: Finalisation...');
            document.getElementById('step4').className = 'step active';

            sessionData.completed = true;
            sessionData.currentStep = 4;
            sessionData.completed_at = new Date().toISOString();

            try {
                const response = await fetch('/api/redis.php/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: `sessions:stepbystep:demo_current`,
                        value: sessionData
                    })
                });

                if (response.ok) {
                    document.getElementById('step4').className = 'step completed';
                    log('‚úÖ Workflow complet termin√© !');
                    log('üéâ Toutes les donn√©es ont √©t√© persist√©es dans Redis');
                    
                    // Afficher un r√©sum√©
                    document.getElementById('session-data').textContent = JSON.stringify(sessionData, null, 2);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur √âtape 4: ${error.message}`);
            }
        }

        async function loadSessionData() {
            log('üìñ Chargement des donn√©es de session depuis Redis...');
            try {
                const response = await fetch('/api/redis.php/get', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        key: 'sessions:stepbystep:demo_current'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.value) {
                        sessionData = data.value;
                        document.getElementById('session-data').textContent = JSON.stringify(sessionData, null, 2);
                        log('‚úÖ Donn√©es de session charg√©es depuis Redis');
                        
                        // Mettre √† jour l'affichage des √©tapes
                        for (let i = 1; i <= sessionData.currentStep; i++) {
                            document.getElementById(`step${i}`).className = 'step completed';
                        }
                    } else {
                        log('‚ÑπÔ∏è Aucune session active trouv√©e');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur chargement session: ${error.message}`);
            }
        }

        async function simulateFullWorkflow() {
            log('üöÄ D√©marrage du workflow complet...');
            currentStep = 1;
            
            // Reset visual state
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).className = 'step';
            }

            await simulateStep1();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await simulateStep2();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await simulateStep3();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await simulateStep4();
            
            log('üéØ Workflow automatique termin√© !');
        }

        async function clearRedisData() {
            log('üóëÔ∏è Nettoyage des donn√©es Redis...');
            try {
                const response = await fetch('/api/redis.php/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pattern: 'sessions:stepbystep:demo*'
                    })
                });

                if (response.ok) {
                    log('‚úÖ Donn√©es Redis nettoy√©es');
                    sessionData = {};
                    document.getElementById('session-data').textContent = 'Aucune donn√©e de session';
                    
                    // Reset steps
                    for (let i = 1; i <= 4; i++) {
                        document.getElementById(`step${i}`).className = 'step';
                    }
                    currentStep = 1;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erreur nettoyage: ${error.message}`);
            }
        }

        function clearLog() {
            document.getElementById('operation-log').textContent = 'Log effac√©...\n';
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('üéÆ Interface de d√©monstration Redis initialis√©e');
            log('üí° Utilisez les boutons pour tester le stockage des sessions');
            checkRedisStatus();
        });
    </script>
</body>
</html>
