<!DOCTYPE html>
<html>
<head>
    <title>Test Timing Fix - Simple</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üß™ Test Timing Fix - Saitek X-56</h1>
    <p>Test de la correction du probl√®me de timing pour la d√©tection du Saitek X-56</p>
    
    <div id="status" class="result info">‚è≥ Test en cours...</div>
    <div id="console-logs" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; height: 300px; overflow-y: scroll;"></div>

    <script type="module">
        // Capturer les logs pour l'affichage
        const logsDiv = document.getElementById('console-logs');
        const statusDiv = document.getElementById('status');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        // Test simple du timing fix
        addLog('üß™ Test Timing Fix - D√©but');

        async function testTimingFix() {
            try {
                // 1. Charger les donn√©es comme le fait bindingEditor.js
                addLog('üì• Chargement des donn√©es...');
                const response = await fetch('/get_devices_data.php');
                const devicesData = await response.json();
                
                window.devicesDataJs = devicesData;
                addLog(`‚úÖ devicesDataJs charg√©: ${devicesData.length} devices`);
                
                // V√©rifier si le Saitek est dans les donn√©es
                const saitekInData = devicesData.find(dev => 
                    dev.vendor_id === '0x0738' && dev.product_id === '0xa221'
                );
                addLog(`üìã Saitek X-56 dans les donn√©es: ${saitekInData ? 'OUI' : 'NON'}`);
                
                // 2. Importer SCConfigEditor
                const { SCConfigEditor } = await import('/assets/js/scConfigEditor.js');
                
                // 3. Cr√©er l'instance
                addLog('üöÄ Cr√©ation SCConfigEditor...');
                const editor = new SCConfigEditor({
                    devicesData: devicesData,
                    useSimplifiedAnchoring: true,
                    enableAutoDetection: true
                });
                
                // 4. Attendre 4 secondes pour laisser le waitForDevicesData() se terminer
                addLog('‚è±Ô∏è Attente de 4 secondes pour l\'initialisation compl√®te...');
                
                setTimeout(() => {
                    addLog('üß™ Test de d√©tection du Saitek X-56...');
                    
                    const mockSaitekGamepad = {
                        id: "Saitek Pro Flight X-56 Rhino Throttle (Vendor: 0738 Product: a221)",
                        index: 0,
                        connected: true
                    };
                    
                    addLog(`üîç Test avec gamepad ID: ${mockSaitekGamepad.id}`);
                    addLog(`üîç window.devicesDataJs disponible: ${!!window.devicesDataJs}`);
                    addLog(`üîç Nombre de devices: ${window.devicesDataJs?.length || 0}`);
                    
                    const isKnown = editor.deviceAutoDetection.isDeviceKnown(mockSaitekGamepad);
                    addLog(`üìã R√©sultat isDeviceKnown: ${isKnown}`);
                    
                    if (isKnown) {
                        addLog('‚úÖ SUCC√àS: Saitek X-56 d√©tect√© comme CONNU');
                        statusDiv.className = 'result success';
                        statusDiv.textContent = '‚úÖ SUCC√àS: Le timing fix fonctionne ! Le Saitek X-56 est maintenant d√©tect√© comme device CONNU.';
                    } else {
                        addLog('‚ùå √âCHEC: Saitek X-56 encore d√©tect√© comme INCONNU');
                        statusDiv.className = 'result error';
                        statusDiv.textContent = '‚ùå √âCHEC: Le timing fix ne fonctionne pas encore. Le Saitek est toujours d√©tect√© comme INCONNU.';
                        
                        // Debug suppl√©mentaire
                        addLog('üîç DEBUG: Extraction des IDs du gamepad...');
                        const ids = editor.deviceAutoDetection.extractVendorProductIdFromGamepad(mockSaitekGamepad);
                        addLog(`üîç DEBUG: IDs extraits - vendor: ${ids.vendor}, product: ${ids.product}`);
                        
                        // V√©rifier manuellement dans les donn√©es
                        const manualFind = window.devicesDataJs.find(dev => {
                            const devVendor = dev.vendor_id?.replace(/^0x/, '').toLowerCase();
                            const devProduct = dev.product_id?.replace(/^0x/, '').toLowerCase();
                            addLog(`üîç DEBUG: Comparaison avec ${dev.id} - vendor: ${devVendor}, product: ${devProduct}`);
                            return devVendor === ids.vendor && devProduct === ids.product;
                        });
                        addLog(`üîç DEBUG: Recherche manuelle trouv√©e: ${!!manualFind}`);
                    }
                }, 4000);
                
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`);
                statusDiv.className = 'result error';
                statusDiv.textContent = `‚ùå ERREUR: ${error.message}`;
            }
        }

        // Lancer le test
        testTimingFix();
    </script>
</body>
</html>
