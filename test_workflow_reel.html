<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Test R√©el - Simulation Upload XML</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover { background: #0056b3; }
        .test-button.success { background: #28a745; }
        .test-button.success:hover { background: #218838; }
        .iframe-container {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            height: 700px;
            margin-top: 20px;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        .step {
            background: #e9ecef;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
        }
        .step.active {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .step.completed {
            background: #d4edda;
            border-left-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Test R√©el - Workflow Upload XML</h1>
        <p>Ce test simule exactement le workflow utilisateur pour v√©rifier l'apparition de la section "Gestion des dispositifs"</p>

        <div class="test-section">
            <h2>üìã Plan de Test</h2>
            <div class="step" id="step-1">
                <strong>√âtape 1:</strong> Charger la page initiale (formulaire d'upload)
                <button class="test-button" id="load-editor">üöÄ Charger √âditeur</button>
            </div>
            <div class="step" id="step-2">
                <strong>√âtape 2:</strong> Pr√©parer le fichier XML de test
                <button class="test-button" id="prepare-xml">üìÑ Pr√©parer XML</button>
            </div>
            <div class="step" id="step-3">
                <strong>√âtape 3:</strong> Simuler l'upload (POST avec FormData)
                <button class="test-button" id="simulate-upload">üì§ Simuler Upload</button>
            </div>
            <div class="step" id="step-4">
                <strong>√âtape 4:</strong> V√©rifier l'apparition du tableau
                <button class="test-button" id="check-table">üîç V√©rifier Tableau</button>
            </div>
            <div class="step" id="step-5">
                <strong>√âtape 5:</strong> <strong style="color: #dc3545;">CRIT√àRE PRINCIPAL</strong> - D√©tecter la section "Gestion des dispositifs"
                <button class="test-button" id="check-section">üéØ V√©rifier Section</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ü§ñ Contr√¥les Automatiques</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="test-button" id="auto-full-test">üöÄ Test Complet Auto</button>
                <button class="test-button" id="manual-test">üë§ Test Manuel Guid√©</button>
                <button class="test-button" id="debug-integration">üî¨ Debug Int√©gration</button>
                <button class="test-button" id="reset-test">üîÑ Reset</button>
            </div>
            <div id="test-status" class="status info">
                En attente de d√©marrage...
            </div>
        </div>

        <div class="test-section">
            <h2>üìä Logs de Test</h2>
            <div id="log-container" class="log-container">
                <div style="color: #007bff;">[INFO] Syst√®me de test initialis√©</div>
            </div>
        </div>

        <div class="test-section">
            <h2>üñ•Ô∏è Interface de Test</h2>
            <div class="iframe-container">
                <iframe id="test-iframe" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <script>
        class RealWorkflowTest {
            constructor() {
                this.iframe = document.getElementById('test-iframe');
                this.logContainer = document.getElementById('log-container');
                this.currentStep = 0;
                this.testResults = {
                    editorLoaded: false,
                    xmlPrepared: false,
                    uploadSimulated: false,
                    tableDetected: false,
                    sectionDetected: false
                };

                this.bindEvents();
                this.log('üéØ Test de workflow r√©el initialis√©', 'info');
            }

            bindEvents() {
                document.getElementById('load-editor').addEventListener('click', () => this.loadEditor());
                document.getElementById('prepare-xml').addEventListener('click', () => this.prepareXML());
                document.getElementById('simulate-upload').addEventListener('click', () => this.simulateUpload());
                document.getElementById('check-table').addEventListener('click', () => this.checkTable());
                document.getElementById('check-section').addEventListener('click', () => this.checkSection());
                
                document.getElementById('auto-full-test').addEventListener('click', () => this.runFullAutoTest());
                document.getElementById('manual-test').addEventListener('click', () => this.startManualTest());
                document.getElementById('debug-integration').addEventListener('click', () => this.debugIntegration());
                document.getElementById('reset-test').addEventListener('click', () => this.resetTest());
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const colors = {
                    info: '#007bff',
                    success: '#28a745',
                    error: '#dc3545',
                    warning: '#ffc107'
                };

                const logEntry = document.createElement('div');
                logEntry.style.color = colors[type] || '#000';
                logEntry.innerHTML = `[${timestamp}] ${message}`;
                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
            }

            setStepStatus(stepNumber, status) {
                const step = document.getElementById(`step-${stepNumber}`);
                step.className = `step ${status}`;
            }

            updateTestStatus(message, type = 'info') {
                const statusEl = document.getElementById('test-status');
                statusEl.className = `status ${type}`;
                statusEl.textContent = message;
            }

            async loadEditor() {
                this.log('üöÄ Chargement de l\'√©diteur...', 'info');
                this.setStepStatus(1, 'active');

                try {
                    this.iframe.src = 'keybind_editor.php';
                    
                    // Attendre le chargement
                    await this.waitForIframeLoad();
                    
                    this.testResults.editorLoaded = true;
                    this.setStepStatus(1, 'completed');
                    this.log('‚úÖ √âditeur charg√© avec succ√®s', 'success');
                    this.currentStep = 1;
                    
                } catch (error) {
                    this.log(`‚ùå Erreur chargement √©diteur: ${error.message}`, 'error');
                    this.setStepStatus(1, 'error');
                }
            }

            async prepareXML() {
                this.log('üìÑ Pr√©paration du fichier XML...', 'info');
                this.setStepStatus(2, 'active');

                try {
                    // V√©rifier que le fichier XML existe
                    const response = await fetch('test_integration_xml.xml');
                    if (response.ok) {
                        const xmlContent = await response.text();
                        this.xmlContent = xmlContent;
                        this.testResults.xmlPrepared = true;
                        this.setStepStatus(2, 'completed');
                        this.log('‚úÖ Fichier XML pr√©par√©', 'success');
                        this.currentStep = 2;
                    } else {
                        throw new Error('Fichier XML non trouv√©');
                    }
                } catch (error) {
                    this.log(`‚ùå Erreur pr√©paration XML: ${error.message}`, 'error');
                    this.setStepStatus(2, 'error');
                }
            }

            async simulateUpload() {
                this.log('üì§ Simulation de l\'upload...', 'info');
                this.setStepStatus(3, 'active');

                try {
                    if (!this.xmlContent) {
                        throw new Error('XML non pr√©par√©');
                    }

                    // Cr√©er un FormData avec le fichier XML
                    const formData = new FormData();
                    const blob = new Blob([this.xmlContent], { type: 'application/xml' });
                    formData.append('xmlfile', blob, 'test_integration_xml.xml');

                    // Envoyer la requ√™te POST
                    const response = await fetch('keybind_editor.php', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const html = await response.text();
                        
                        // Injecter le HTML de r√©ponse dans l'iframe
                        const doc = this.iframe.contentDocument;
                        doc.open();
                        doc.write(html);
                        doc.close();

                        this.testResults.uploadSimulated = true;
                        this.setStepStatus(3, 'completed');
                        this.log('‚úÖ Upload simul√© avec succ√®s', 'success');
                        this.currentStep = 3;

                        // Attendre un peu pour que les scripts se chargent
                        setTimeout(() => {
                            this.checkTable();
                        }, 2000);

                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }

                } catch (error) {
                    this.log(`‚ùå Erreur simulation upload: ${error.message}`, 'error');
                    this.setStepStatus(3, 'error');
                }
            }

            async checkTable() {
                this.log('üîç V√©rification du tableau de bindings...', 'info');
                this.setStepStatus(4, 'active');

                try {
                    const doc = this.iframe.contentDocument;
                    const table = doc.getElementById('bindings-table');

                    if (table) {
                        this.testResults.tableDetected = true;
                        this.setStepStatus(4, 'completed');
                        this.log('‚úÖ Tableau de bindings d√©tect√©', 'success');
                        this.log(`üìä Tableau contient ${table.rows.length} lignes`, 'info');
                        this.currentStep = 4;

                        // Automatiquement v√©rifier la section
                        setTimeout(() => {
                            this.checkSection();
                        }, 1000);

                    } else {
                        throw new Error('Tableau bindings-table non trouv√©');
                    }

                } catch (error) {
                    this.log(`‚ùå Erreur v√©rification tableau: ${error.message}`, 'error');
                    this.setStepStatus(4, 'error');
                }
            }

            async checkSection() {
                this.log('üéØ V√âRIFICATION CRITIQUE: Section Gestion des dispositifs...', 'warning');
                this.setStepStatus(5, 'active');

                try {
                    const doc = this.iframe.contentDocument;
                    
                    // Chercher la section de gestion des dispositifs
                    const deviceSection = doc.querySelector('.device-management-section');
                    const deviceButton = doc.getElementById('open-device-manager');
                    const deviceHeader = doc.querySelector('h4:contains("Gestion des Dispositifs")');
                    
                    // Chercher par contenu textuel
                    const allElements = doc.querySelectorAll('*');
                    let foundDeviceManagement = false;
                    
                    for (let element of allElements) {
                        if (element.textContent && element.textContent.includes('Gestion des dispositifs')) {
                            foundDeviceManagement = true;
                            this.log(`‚úÖ Section trouv√©e dans: ${element.tagName}`, 'success');
                            break;
                        }
                    }

                    if (foundDeviceManagement || deviceSection || deviceButton) {
                        this.testResults.sectionDetected = true;
                        this.setStepStatus(5, 'completed');
                        this.log('üéâ SUCC√àS! Section "Gestion des dispositifs" d√©tect√©e!', 'success');
                        this.updateTestStatus('‚úÖ TEST R√âUSSI - Section d√©tect√©e!', 'success');
                        this.currentStep = 5;

                        // V√©rifier les √©l√©ments de la section
                        this.inspectDeviceSection(doc);

                    } else {
                        this.log('‚ùå Section "Gestion des dispositifs" NON d√©tect√©e', 'error');
                        this.log('üîç Inspection du DOM pour diagnostic...', 'warning');
                        this.inspectDOM(doc);
                        this.setStepStatus(5, 'error');
                        this.updateTestStatus('‚ùå √âCHEC - Section non d√©tect√©e', 'error');
                    }

                } catch (error) {
                    this.log(`‚ùå Erreur v√©rification section: ${error.message}`, 'error');
                    this.setStepStatus(5, 'error');
                }
            }

            inspectDeviceSection(doc) {
                this.log('üîç Inspection de la section d√©tect√©e...', 'info');
                
                const deviceButton = doc.getElementById('open-device-manager');
                if (deviceButton) {
                    this.log('‚úÖ Bouton "G√©rer les dispositifs" trouv√©', 'success');
                }

                const importButton = doc.getElementById('import-device-json');
                if (importButton) {
                    this.log('‚úÖ Bouton "Importer JSON" trouv√©', 'success');
                }

                const deviceCount = doc.getElementById('device-count');
                if (deviceCount) {
                    this.log(`‚úÖ Compteur de dispositifs: ${deviceCount.textContent}`, 'success');
                }
            }

            inspectDOM(doc) {
                this.log('üîç Diagnostic DOM...', 'warning');
                
                // V√©rifier si les scripts sont charg√©s
                const scripts = doc.querySelectorAll('script[src*="bindingEditor"]');
                this.log(`üìù Scripts bindingEditor trouv√©s: ${scripts.length}`, 'info');

                // V√©rifier l'objet global
                const iframeWindow = this.iframe.contentWindow;
                if (iframeWindow.bindingEditorIntegration) {
                    const integration = iframeWindow.bindingEditorIntegration;
                    this.log(`üîß BindingEditorIntegration pr√©sent: ${!!integration}`, 'info');
                    this.log(`üîß Est initialis√©: ${integration.isInitialized}`, 'info');
                } else {
                    this.log('‚ùå BindingEditorIntegration non trouv√©', 'error');
                }

                // V√©rifier la structure DOM apr√®s les filtres
                const filterDiv = doc.getElementById('filter-nonempty');
                if (filterDiv) {
                    this.log('‚úÖ √âl√©ment filter-nonempty trouv√©', 'success');
                    const parent = filterDiv.parentElement;
                    if (parent) {
                        this.log(`üìä Parent du filtre: ${parent.tagName}.${parent.className}`, 'info');
                        this.log(`üìä √âl√©ments suivants: ${parent.nextElementSibling ? parent.nextElementSibling.tagName : 'aucun'}`, 'info');
                    }
                } else {
                    this.log('‚ùå √âl√©ment filter-nonempty non trouv√©', 'error');
                }
            }

            async runFullAutoTest() {
                this.log('üöÄ D√©marrage du test complet automatique...', 'info');
                this.updateTestStatus('üîÑ Test automatique en cours...', 'warning');

                try {
                    await this.loadEditor();
                    await this.delay(1000);
                    await this.prepareXML();
                    await this.delay(500);
                    await this.simulateUpload();
                    await this.delay(3000); // Attendre que les scripts s'ex√©cutent
                    
                    this.log('üéØ Test automatique termin√©', 'info');
                    
                } catch (error) {
                    this.log(`‚ùå Erreur dans le test automatique: ${error.message}`, 'error');
                    this.updateTestStatus('‚ùå Test automatique √©chou√©', 'error');
                }
            }

            startManualTest() {
                this.log('üë§ D√©marrage du test manuel guid√©...', 'info');
                this.updateTestStatus('üìã Test manuel - Suivez les √©tapes', 'info');
                
                // Ouvrir l'√©diteur dans l'iframe
                this.iframe.src = 'keybind_editor.php';
                
                this.log('üìã INSTRUCTIONS MANUELLES:', 'warning');
                this.log('1. Dans l\'iframe, cliquez sur "Choisir un fichier"', 'info');
                this.log('2. S√©lectionnez le fichier test_integration_xml.xml', 'info');
                this.log('3. Attendez l\'affichage du tableau de bindings', 'info');
                this.log('4. CHERCHEZ la section "Gestion des dispositifs"', 'warning');
            }

            debugIntegration() {
                window.open('test_advanced_debug.html', '_blank');
                this.log('üî¨ Interface de debug ouverte dans un nouvel onglet', 'info');
            }

            resetTest() {
                this.currentStep = 0;
                this.testResults = {
                    editorLoaded: false,
                    xmlPrepared: false,
                    uploadSimulated: false,
                    tableDetected: false,
                    sectionDetected: false
                };

                for (let i = 1; i <= 5; i++) {
                    this.setStepStatus(i, '');
                }

                this.iframe.src = 'about:blank';
                this.updateTestStatus('üîÑ Test r√©initialis√©', 'info');
                this.log('üîÑ Test r√©initialis√© - Pr√™t pour nouveau test', 'warning');
            }

            waitForIframeLoad() {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout chargement iframe'));
                    }, 10000);

                    this.iframe.onload = () => {
                        clearTimeout(timeout);
                        resolve();
                    };
                });
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialisation automatique
        document.addEventListener('DOMContentLoaded', () => {
            new RealWorkflowTest();
        });
    </script>
</body>
</html>
