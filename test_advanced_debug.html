<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug Avanc√© Int√©gration</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f8f9fa; 
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        .full-width { grid-column: span 2; }
        
        h1 { color: #495057; margin-bottom: 30px; text-align: center; }
        h3 { color: #6c757d; margin-top: 0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
        
        .btn { 
            display: inline-block;
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            margin: 4px;
            transition: all 0.2s ease;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        
        .logs-container {
            background: #1e1e1e;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-error { color: #ff6b6b; font-weight: bold; }
        .log-warn { color: #ffd93d; font-weight: bold; }
        .log-success { color: #51cf66; font-weight: bold; }
        .log-info { color: #74c0fc; }
        .log-debug { color: #ced4da; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-pending { background: #6c757d; }
        
        .checklist {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .checklist ul { margin: 0; padding-left: 20px; }
        .checklist li { margin: 8px 0; }
        
        iframe {
            width: 100%;
            height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üîß Debug Avanc√© - Int√©gration Gestion Dispositifs</h1>
    
    <div class="grid">
        
        <!-- Panel de contr√¥le -->
        <div class="panel">
            <h3>üéÆ Contr√¥les de Test</h3>
            
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="openKeybindEditor()">
                    üìÇ Ouvrir √âditeur
                </button>
                <button class="btn btn-info" onclick="downloadTestXML()">
                    üíæ T√©l√©charger XML Test
                </button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <button class="btn btn-warning" onclick="checkIntegration()">
                    üîç V√©rifier Int√©gration
                </button>
                <button class="btn btn-success" onclick="testModal()">
                    üéÆ Tester Modal
                </button>
            </div>
            
            <div>
                <button class="btn btn-info" onclick="exportLogs()">
                    üì§ Exporter Logs
                </button>
                <button class="btn btn-warning" onclick="clearLogs()">
                    üßπ Effacer Logs
                </button>
            </div>
        </div>

        <!-- Statut global -->
        <div class="panel">
            <h3>üìä Statut Global</h3>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="logs-count">0</div>
                    <div class="stat-label">Logs</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="errors-count">0</div>
                    <div class="stat-label">Erreurs</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="success-count">0</div>
                    <div class="stat-label">Succ√®s</div>
                </div>
            </div>
            
            <div id="status-list">
                <div><span class="status-indicator status-pending"></span>√âditeur non ouvert</div>
                <div><span class="status-indicator status-pending"></span>XML non upload√©</div>
                <div><span class="status-indicator status-pending"></span>Int√©gration non v√©rifi√©e</div>
                <div><span class="status-indicator status-pending"></span>Modal non test√©e</div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="panel full-width">
            <h3>üìã Instructions de Test</h3>
            
            <div class="checklist">
                <strong>üéØ Proc√©dure de Test Compl√®te :</strong>
                <ol>
                    <li><strong>Ouvrir l'√©diteur :</strong> Cliquez sur "üìÇ Ouvrir √âditeur" (nouvelle fen√™tre)</li>
                    <li><strong>T√©l√©charger XML :</strong> Cliquez sur "üíæ T√©l√©charger XML Test" pour obtenir le fichier</li>
                    <li><strong>Upload XML :</strong> Dans l'√©diteur, uploadez le fichier t√©l√©charg√©</li>
                    <li><strong>V√©rifier :</strong> Utilisez "üîç V√©rifier Int√©gration" ou observez la console</li>
                    <li><strong>Tester modal :</strong> Cliquez sur "üéÆ Tester Modal" si int√©gration OK</li>
                </ol>
            </div>
            
            <div class="checklist" style="margin-top: 15px;">
                <strong>üëÄ √âl√©ments √† V√©rifier dans l'√âditeur :</strong>
                <ul>
                    <li>‚úÖ Section "üéÆ Gestion des Dispositifs" visible au-dessus du tableau</li>
                    <li>‚úÖ Bouton "G√©rer les dispositifs" pr√©sent et cliquable</li>
                    <li>‚úÖ Bouton "Importer JSON" pr√©sent</li>
                    <li>‚úÖ Compteur "0 dispositifs configur√©s" affich√©</li>
                    <li>‚úÖ Clic sur "G√©rer les dispositifs" ouvre la modal</li>
                </ul>
            </div>
        </div>
        
        <!-- Logs en temps r√©el -->
        <div class="panel full-width">
            <h3>üìù Logs en Temps R√©el</h3>
            <div class="logs-container" id="logs-display">
                <div class="log-info">Initialisation du syst√®me de debug...</div>
                <div class="log-info">En attente des logs de l'√©diteur...</div>
            </div>
        </div>
        
        <!-- Iframe pour l'√©diteur -->
        <div class="panel full-width">
            <h3>üñ•Ô∏è √âditeur de Keybinds</h3>
            <iframe id="editor-iframe" src="about:blank"></iframe>
        </div>
        
    </div>
</div>

<script type="module">
    let editorWindow = null;
    let logInterval = null;
    
    // Variables globales pour tracking
    window.debugStats = {
        logsCount: 0,
        errorsCount: 0,
        successCount: 0
    };

    function updateStats() {
        document.getElementById('logs-count').textContent = window.debugStats.logsCount;
        document.getElementById('errors-count').textContent = window.debugStats.errorsCount;
        document.getElementById('success-count').textContent = window.debugStats.successCount;
    }

    function addLog(message, level = 'info', module = 'Debug') {
        const logsDisplay = document.getElementById('logs-display');
        const timestamp = new Date().toLocaleTimeString();
        
        const logDiv = document.createElement('div');
        logDiv.className = `log-entry log-${level}`;
        logDiv.innerHTML = `[${timestamp}] [${module}] ${message}`;
        
        logsDisplay.appendChild(logDiv);
        logsDisplay.scrollTop = logsDisplay.scrollHeight;
        
        // Mettre √† jour les stats
        window.debugStats.logsCount++;
        if (level === 'error') window.debugStats.errorsCount++;
        if (level === 'success') window.debugStats.successCount++;
        updateStats();
    }

    function updateStatus(index, success, label) {
        const statusList = document.getElementById('status-list');
        const statusItems = statusList.children;
        
        if (statusItems[index]) {
            const indicator = statusItems[index].querySelector('.status-indicator');
            indicator.className = `status-indicator ${success ? 'status-success' : 'status-error'}`;
            statusItems[index].innerHTML = `<span class="status-indicator ${success ? 'status-success' : 'status-error'}"></span>${label}`;
        }
    }

    window.openKeybindEditor = function() {
        addLog('Ouverture de keybind_editor.php...', 'info');
        
        editorWindow = window.open('http://localhost:8080/keybind_editor.php', '_blank', 
            'width=1200,height=800,scrollbars=yes,resizable=yes');
        
        if (editorWindow) {
            updateStatus(0, true, '√âditeur ouvert avec succ√®s');
            addLog('√âditeur ouvert dans une nouvelle fen√™tre', 'success');
            
            // D√©marrer la surveillance des logs depuis l'√©diteur
            startLogMonitoring();
        } else {
            updateStatus(0, false, 'Impossible d\'ouvrir l\'√©diteur');
            addLog('Impossible d\'ouvrir la fen√™tre (popup bloqu√©?)', 'error');
        }
    };

    window.downloadTestXML = function() {
        const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<ActionMaps version="1" optionsVersion="2" profileName="layout_test">
  <CustomisationUIHeader label="Test Integration" />
  <actionmap name="spaceship_general">
    <action name="v_throttle_abs">
      <rebind input="js1_axis1" />
    </action>
    <action name="v_strafe_forward">
      <rebind input="js1_button1" />
    </action>
  </actionmap>
  <joystick>
    <instance value="1" />
    <product value="Test Joystick" />
  </joystick>
</ActionMaps>`;

        const blob = new Blob([xmlContent], { type: 'application/xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'test_integration_xml.xml';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLog('Fichier XML test t√©l√©charg√©: test_integration_xml.xml', 'success');
    };

    window.checkIntegration = function() {
        addLog('V√©rification de l\'int√©gration...', 'info');
        
        if (!editorWindow || editorWindow.closed) {
            addLog('Aucune fen√™tre √©diteur ouverte', 'error');
            return;
        }
        
        try {
            // Tenter d'acc√©der au logger global de l'√©diteur
            const editorLogger = editorWindow.globalLogger;
            
            if (editorLogger) {
                addLog('Logger global trouv√© dans l\'√©diteur', 'success');
                
                // R√©cup√©rer les logs de l'int√©gration
                const integrationLogs = editorLogger.getLogs(null, 'BindingEditorIntegration');
                addLog(`${integrationLogs.length} logs d'int√©gration trouv√©s`, 'info');
                
                // Afficher les logs r√©cents
                integrationLogs.slice(-10).forEach(log => {
                    addLog(log.message, log.level, 'Editor-' + log.module);
                });
                
                // V√©rifier le statut d'initialisation
                const integration = editorWindow.bindingEditorIntegration;
                if (integration && integration.isInitialized) {
                    updateStatus(2, true, 'Int√©gration initialis√©e avec succ√®s');
                    addLog('‚úÖ Int√©gration confirm√©e comme initialis√©e', 'success');
                } else {
                    updateStatus(2, false, 'Int√©gration non initialis√©e');
                    addLog('‚ùå Int√©gration non initialis√©e', 'error');
                }
                
            } else {
                addLog('Logger global non trouv√© dans l\'√©diteur', 'warn');
            }
            
        } catch (error) {
            addLog(`Erreur lors de la v√©rification: ${error.message}`, 'error');
        }
    };

    window.testModal = function() {
        addLog('Test d\'ouverture de la modal...', 'info');
        
        if (!editorWindow || editorWindow.closed) {
            addLog('Aucune fen√™tre √©diteur ouverte', 'error');
            return;
        }
        
        try {
            const integration = editorWindow.bindingEditorIntegration;
            
            if (integration && integration.isInitialized) {
                // Simuler un clic sur le bouton
                const button = editorWindow.document.getElementById('open-device-manager');
                
                if (button) {
                    button.click();
                    addLog('Clic simul√© sur le bouton de gestion', 'info');
                    
                    setTimeout(() => {
                        const modal = editorWindow.document.getElementById('device-manager-modal');
                        if (modal) {
                            updateStatus(3, true, 'Modal ouverte avec succ√®s');
                            addLog('‚úÖ Modal d√©tect√©e et ouverte', 'success');
                        } else {
                            updateStatus(3, false, 'Modal non trouv√©e');
                            addLog('‚ùå Modal non trouv√©e apr√®s clic', 'error');
                        }
                    }, 1000);
                    
                } else {
                    addLog('‚ùå Bouton de gestion non trouv√©', 'error');
                }
            } else {
                addLog('‚ùå Int√©gration non initialis√©e', 'error');
            }
            
        } catch (error) {
            addLog(`Erreur test modal: ${error.message}`, 'error');
        }
    };

    window.exportLogs = function() {
        const logsDisplay = document.getElementById('logs-display');
        const logsText = Array.from(logsDisplay.children)
            .map(child => child.textContent)
            .join('\n');
        
        const blob = new Blob([logsText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `debug-logs-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLog('Logs export√©s vers fichier', 'success');
    };

    window.clearLogs = function() {
        document.getElementById('logs-display').innerHTML = '';
        window.debugStats = { logsCount: 0, errorsCount: 0, successCount: 0 };
        updateStats();
        addLog('Logs effac√©s', 'info');
    };

    function startLogMonitoring() {
        // Surveiller les logs de l'√©diteur toutes les 2 secondes
        logInterval = setInterval(() => {
            if (editorWindow && !editorWindow.closed && editorWindow.globalLogger) {
                // Ici on pourrait synchroniser les logs de l'√©diteur avec notre debug
                // Pour l'instant, on v√©rifie juste que le logger est accessible
            }
        }, 2000);
        
        addLog('Surveillance des logs de l\'√©diteur d√©marr√©e', 'info');
    }

    // Initialisation
    window.addEventListener('DOMContentLoaded', () => {
        addLog('Page de debug charg√©e et pr√™te', 'success');
        updateStats();
    });

    // Nettoyage √† la fermeture
    window.addEventListener('beforeunload', () => {
        if (logInterval) {
            clearInterval(logInterval);
        }
    });
</script>

</body>
</html>
