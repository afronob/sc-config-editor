<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Validation XML Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .scenario {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .scenario.no-xml {
            border-color: #dc3545;
            background: #fff5f5;
        }
        .scenario.with-xml {
            border-color: #28a745;
            background: #f8fff8;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.success {
            background: #28a745;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
        }
        input[type="text"] {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .gamepad-highlight {
            background-color: #ffeb3b !important;
            animation: pulse 0.5s ease-in-out;
        }
        @keyframes pulse {
            0% { background-color: #ffeb3b; }
            50% { background-color: #fff59d; }
            100% { background-color: #ffeb3b; }
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üß™ Test Final - Validation D√©tection XML</h1>
        <p>Ce test v√©rifie que le syst√®me SimplifiedBindingsHandler ne montre plus d'overlays quand aucun XML n'est charg√©.</p>
        <p><strong>Objectif :</strong> Confirmer que le fix emp√™che l'affichage d'overlays sur keybind_editor.php sans XML.</p>
    </div>

    <!-- Sc√©nario 1 : Sans XML (simulation keybind_editor.php) -->
    <div class="scenario no-xml">
        <h2>üö´ Sc√©nario 1 : Sans XML charg√© (comme keybind_editor.php)</h2>
        <div id="status-no-xml" class="status error">Non test√©</div>
        <p>Simulation de l'√©tat initial sur keybind_editor.php o√π aucun XML n'est charg√©.</p>
        
        <!-- Table vide comme sur keybind_editor.php -->
        <div style="display: none;">
            <table id="bindings-table-empty">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Action</th>
                        <th>Name</th>
                        <th>Input</th>
                        <th>Opts</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aucune ligne de donn√©es -->
                </tbody>
            </table>
        </div>

        <button class="btn danger" onclick="testNoXML()">üß™ Tester Sans XML</button>
        <button class="btn" onclick="simulateGamepadInput('no-xml')">üéÆ Simuler Input Gamepad</button>
    </div>

    <!-- Sc√©nario 2 : Avec XML charg√© -->
    <div class="scenario with-xml">
        <h2>‚úÖ Sc√©nario 2 : Avec XML charg√© (comportement normal)</h2>
        <div id="status-with-xml" class="status error">Non test√©</div>
        <p>Simulation du comportement normal quand un XML est charg√© avec des donn√©es valides.</p>
        
        <!-- Table avec donn√©es comme dans edit_form.php -->
        <table id="bindings-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Action</th>
                    <th>Name</th>
                    <th>Input</th>
                    <th>Opts</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>spaceship_movement</td>
                    <td>v_pitch</td>
                    <td>Pitch</td>
                    <td><input name="input[spaceship_movement][v_pitch][0]" value="js1_button1"></td>
                    <td><input name="opts[spaceship_movement][v_pitch][0]" value=""></td>
                    <td><input name="value[spaceship_movement][v_pitch][0]" value=""></td>
                </tr>
                <tr>
                    <td>spaceship_weapons</td>
                    <td>v_attack1</td>
                    <td>Fire Primary</td>
                    <td><input name="input[spaceship_weapons][v_attack1][0]" value="js1_button2"></td>
                    <td><input name="opts[spaceship_weapons][v_attack1][0]" value="ActivationMode"></td>
                    <td><input name="value[spaceship_weapons][v_attack1][0]" value="hold"></td>
                </tr>
                <tr>
                    <td>spaceship_weapons</td>
                    <td>v_attack2</td>
                    <td>Fire Secondary</td>
                    <td><input name="input[spaceship_weapons][v_attack2][0]" value="js1_button3"></td>
                    <td><input name="opts[spaceship_weapons][v_attack2][0]" value="activationmode"></td>
                    <td><input name="value[spaceship_weapons][v_attack2][0]" value="double_tap"></td>
                </tr>
            </tbody>
        </table>

        <button class="btn success" onclick="testWithXML()">üß™ Tester Avec XML</button>
        <button class="btn" onclick="simulateGamepadInput('with-xml')">üéÆ Simuler Input Gamepad</button>
    </div>

    <!-- Log des √©v√©nements -->
    <div class="card">
        <h3>üìú Log des Tests</h3>
        <button class="btn" onclick="clearLog()">üóëÔ∏è Effacer Log</button>
        <div id="log" class="log"></div>
    </div>

    <!-- R√©sultats -->
    <div class="card">
        <h3>üìä R√©sultats du Test</h3>
        <div id="results">
            <p>Les tests n'ont pas encore √©t√© ex√©cut√©s.</p>
        </div>
    </div>

    <script type="module">
        import { SimplifiedBindingsHandler } from './assets/js/modules/simplifiedBindingsHandler.js';
        
        let simplifiedHandler;
        let testResults = {
            noXML: null,
            withXML: null
        };
        
        // Fonction de logging
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const colors = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            const entry = document.createElement('div');
            entry.style.color = colors[type] || colors.info;
            entry.style.marginBottom = '2px';
            entry.textContent = `[${now}] ${message}`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Fonction pour effacer le log
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            log('Log effac√©', 'info');
        };
        
        // Test sans XML
        window.testNoXML = function() {
            log('üö´ D√âBUT TEST SANS XML', 'warning');
            
            // Masquer la table avec XML et montrer la table vide
            const tableWithXML = document.getElementById('bindings-table');
            const tableEmpty = document.getElementById('bindings-table-empty');
            
            if (tableWithXML) tableWithXML.style.display = 'none';
            if (tableEmpty) tableEmpty.style.display = 'table';
            
            // Cr√©er une nouvelle instance du handler
            simplifiedHandler = new SimplifiedBindingsHandler();
            
            // Tester la d√©tection XML
            const xmlLoaded = simplifiedHandler.isXMLLoaded();
            log(`isXMLLoaded() r√©sultat: ${xmlLoaded}`, xmlLoaded ? 'error' : 'success');
            
            // Tester l'ancrage
            const result = simplifiedHandler.anchorToInput('button', 1, 'button1', '');
            log(`anchorToInput() r√©sultat: ${result}`, result === null ? 'success' : 'error');
            
            // V√©rifier qu'aucun overlay n'est cr√©√©
            const overlays = document.querySelectorAll('#gamepad-overlay, .gamepad-overlay');
            log(`Nombre d'overlays cr√©√©s: ${overlays.length}`, overlays.length === 0 ? 'success' : 'error');
            
            testResults.noXML = {
                xmlDetected: xmlLoaded,
                anchorResult: result,
                overlaysCreated: overlays.length
            };
            
            updateStatus('no-xml', !xmlLoaded && result === null && overlays.length === 0);
            updateResults();
            
            log('‚úÖ FIN TEST SANS XML', 'success');
        };
        
        // Test avec XML
        window.testWithXML = function() {
            log('‚úÖ D√âBUT TEST AVEC XML', 'warning');
            
            // Montrer la table avec XML et masquer la table vide
            const tableWithXML = document.getElementById('bindings-table');
            const tableEmpty = document.getElementById('bindings-table-empty');
            
            if (tableWithXML) tableWithXML.style.display = 'table';
            if (tableEmpty) tableEmpty.style.display = 'none';
            
            // Cr√©er une nouvelle instance du handler
            simplifiedHandler = new SimplifiedBindingsHandler();
            
            // Tester la d√©tection XML
            const xmlLoaded = simplifiedHandler.isXMLLoaded();
            log(`isXMLLoaded() r√©sultat: ${xmlLoaded}`, xmlLoaded ? 'success' : 'error');
            
            // Tester l'ancrage (devrait fonctionner)
            const result = simplifiedHandler.anchorToInput('button', 1, 'button1', '');
            log(`anchorToInput() r√©sultat: ${result ? 'trouv√©' : 'null'}`, result ? 'success' : 'error');
            
            testResults.withXML = {
                xmlDetected: xmlLoaded,
                anchorResult: result,
                rowFound: result !== null
            };
            
            updateStatus('with-xml', xmlLoaded && result !== null);
            updateResults();
            
            log('‚úÖ FIN TEST AVEC XML', 'success');
        };
        
        // Simulation d'input gamepad
        window.simulateGamepadInput = function(scenario) {
            log(`üéÆ Simulation input gamepad pour ${scenario}`, 'info');
            
            if (!simplifiedHandler) {
                log('‚ùå Handler non initialis√©, lancez d\'abord un test', 'error');
                return;
            }
            
            // Simuler plusieurs types d'inputs
            const inputs = [
                { type: 'button', instance: 1, element: 'button1', mode: '' },
                { type: 'button', instance: 1, element: 'button2', mode: 'hold' },
                { type: 'button', instance: 1, element: 'button3', mode: 'double_tap' }
            ];
            
            inputs.forEach((input, index) => {
                setTimeout(() => {
                    const result = simplifiedHandler.anchorToInput(input.type, input.instance, input.element, input.mode);
                    log(`Input ${input.element} (${input.mode || 'normal'}): ${result ? 'ancr√©' : 'ignor√©'}`, 
                        result ? 'success' : 'info');
                }, index * 500);
            });
        };
        
        // Mise √† jour du statut
        function updateStatus(scenario, success) {
            const statusDiv = document.getElementById(`status-${scenario}`);
            if (statusDiv) {
                statusDiv.textContent = success ? 'Test r√©ussi' : 'Test √©chou√©';
                statusDiv.className = `status ${success ? 'ok' : 'error'}`;
            }
        }
        
        // Mise √† jour des r√©sultats
        function updateResults() {
            const resultsDiv = document.getElementById('results');
            
            let html = '<h4>R√©sum√© des Tests</h4>';
            
            if (testResults.noXML) {
                const { xmlDetected, anchorResult, overlaysCreated } = testResults.noXML;
                const success = !xmlDetected && anchorResult === null && overlaysCreated === 0;
                
                html += `
                    <div class="scenario no-xml">
                        <h5>üö´ Sans XML: <span class="status ${success ? 'ok' : 'error'}">${success ? 'R√âUSSI' : '√âCHOU√â'}</span></h5>
                        <ul>
                            <li>XML d√©tect√©: ${xmlDetected ? '‚ùå OUI (erreur)' : '‚úÖ NON (correct)'}</li>
                            <li>Ancrage activ√©: ${anchorResult === null ? '‚úÖ NON (correct)' : '‚ùå OUI (erreur)'}</li>
                            <li>Overlays cr√©√©s: ${overlaysCreated === 0 ? '‚úÖ AUCUN (correct)' : `‚ùå ${overlaysCreated} (erreur)`}</li>
                        </ul>
                    </div>
                `;
            }
            
            if (testResults.withXML) {
                const { xmlDetected, anchorResult, rowFound } = testResults.withXML;
                const success = xmlDetected && rowFound;
                
                html += `
                    <div class="scenario with-xml">
                        <h5>‚úÖ Avec XML: <span class="status ${success ? 'ok' : 'error'}">${success ? 'R√âUSSI' : '√âCHOU√â'}</span></h5>
                        <ul>
                            <li>XML d√©tect√©: ${xmlDetected ? '‚úÖ OUI (correct)' : '‚ùå NON (erreur)'}</li>
                            <li>Ancrage activ√©: ${rowFound ? '‚úÖ OUI (correct)' : '‚ùå NON (erreur)'}</li>
                        </ul>
                    </div>
                `;
            }
            
            if (testResults.noXML && testResults.withXML) {
                const noXMLSuccess = !testResults.noXML.xmlDetected && 
                                  testResults.noXML.anchorResult === null && 
                                  testResults.noXML.overlaysCreated === 0;
                const withXMLSuccess = testResults.withXML.xmlDetected && testResults.withXML.rowFound;
                const overallSuccess = noXMLSuccess && withXMLSuccess;
                
                html += `
                    <div class="card" style="margin-top: 20px; border: 3px solid ${overallSuccess ? '#28a745' : '#dc3545'};">
                        <h4>üéØ R√âSULTAT GLOBAL: <span class="status ${overallSuccess ? 'ok' : 'error'}">${overallSuccess ? 'TOUS LES TESTS R√âUSSIS' : 'UN OU PLUSIEURS TESTS √âCHOU√âS'}</span></h4>
                        <p>${overallSuccess ? 
                            'üéâ Le fix fonctionne parfaitement ! Les overlays ne s\'affichent plus sur keybind_editor.php sans XML.' :
                            '‚ö†Ô∏è Il y a encore des probl√®mes √† r√©soudre.'
                        }</p>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Test de validation XML initialis√©', 'info');
            log('Cliquez sur les boutons de test pour commencer', 'info');
        });
        
        // Exposer les fonctions globalement
        window.log = log;
    </script>
</body>
</html>
